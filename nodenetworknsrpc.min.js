(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.nodenetworknsrpc = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var AgnosticRouter=require("agnostic-router"),Utils=require("./Utils");module.exports={_sanitizeArgumentConfig:function(t){var r={level:0},e=Utils.objectMerge(r,t);return void 0===e.source?e.source=[]:Array.isArray(e.source)||(e.source=[e.source]),e},toObject:function(t,r){var e=this,n={},o=AgnosticRouter(),i=o.UrlPattern;return Utils.objectForEach(t,function(t,o){if("string"!=typeof t.pattern)throw new Error("pattern_undefined");var a=new i(t.pattern),s=Array.isArray(t.arguments)?t.arguments:[];n[o]=function(){var t=Array.prototype.slice.call(arguments);if(t.length>0&&"function"==typeof t[t.length-1])var n=t.pop();var i=Utils.parseArgs(t,s),c={};s.forEach(function(t){var r=e._sanitizeArgumentConfig(t);Utils.objectSet(c,r.source.concat([r.name]),i[r.name])});var u=a.stringify(c.params);r(o,u,c,n)}}),n},toRouter:function(t,r,e){var n=this;return"object"!=typeof e&&(e=AgnosticRouter()),Utils.objectForEach(t,function(t,o){if("string"!=typeof t.pattern)throw new Error("pattern_undefined");e.use(t.pattern,function(e,i,a){var s=[];Array.isArray(t.arguments)&&t.arguments.forEach(function(t){var r=n._sanitizeArgumentConfig(t),o=r.source.concat(r.name);(0==r.level||Utils.objectIsset(e,o))&&s.push(Utils.objectGet(e,o))}),r[o].apply(r,s.concat([i]))})}),e}};
},{"./Utils":2,"agnostic-router":3}],2:[function(require,module,exports){
var Utils={};Utils.objectMerge=function(){var t={};return this.objectForEach(arguments,function(e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])}),t},Utils.objectFilter=function(t,e){var r={};return this.objectForEach(t,function(t,i,o){e(t,i,o)&&(r[i]=t)}),r},Utils.objectForEach=function(t,e){var r;for(r in t)t.hasOwnProperty(r)&&e(t[r],r,t)},Utils.objectGet=function(t,e){var r=this;if(0==e.length)return t;if("object"==typeof t){if(("string"==typeof e[0]||"number"==typeof e[0])&&null!==t&&t.hasOwnProperty(e[0]))return this.objectGet(t[e[0]],e.slice(1));if(null===e[0]){if(Array.isArray(t)){var i=[];t.forEach(function(t,o){i[o]=r.objectGet(t,e.slice(1))})}else{var i={};this.objectForEach(t,function(t,o){i[o]=r.objectGet(t,e.slice(1))})}return i}if(e[0]instanceof RegExp){var i={};return this.objectForEach(t,function(t,o){o.match(e[0])&&(i[o]=r.objectGet(t,e.slice(1)))}),i}if("function"==typeof e[0]){if(t instanceof Array){var i=[];t.forEach(function(t,o,n){e[0](t,o,n)&&(i[o]=r.objectGet(t,e.slice(1)))})}else{var i={};this.objectForEach(r.objectFilter(t,e[0]),function(t,o){i[o]=r.objectGet(t,e.slice(1))})}return i}if(e[0]instanceof Array){if(t instanceof Array){var i=[];e[0].forEach(function(e,r){i[r]=t[r]})}else{var i={};this.objectForEach(r.objectFilterProperties(t,e[0]),function(t,o){i[o]=r.objectGet(t,e.slice(1))})}return i}}},Utils.objectSet=function(t,e,r){return 1==e.length?(t[e[0]]=r,!0):(void 0===t[e[0]]&&(t[e[0]]={}),this.objectSet(t[e[0]],e.slice(1),r))},Utils.objectIsset=function(t,e){return 1==e.length?void 0!==t[e[0]]:void 0!==t[e[0]]&&this.objectIsset(t[e[0]],e.slice(1))},Utils.parseArgs=function(t,e){function r(t,e){return"function"==typeof t.validate?t.validate(e):"string"==typeof t.type?typeof e==t.type:!Array.isArray(t.types)||t.types.indexOf(typeof e)>=0}function i(t,e){for(var r=e;r<t.length;r++)if(void 0===t[r]||!t[r].required)return!0;return!1}var o={},n=0;return Array.isArray(t)||(t=Array.prototype.slice.call(t)),t.forEach(function(t,c){for(var a=n;a<e.length;a++){if(e[a].required){if(r(e[a],t)){e[a].matched=!0,o[e[a].name]=t,n++;break}throw"missing_required"}if(!e[a].required&&(i(e,a)||e[a].level>e[a-1].level&&e[a-1].matched)&&r(e[a],t)){e[a].matched=!0,o[e[a].name]=t,n++;break}e[a].matched=!1,n++}}),e.forEach(function(t){void 0===o[t.name]&&void 0!==t.default&&(o[t.name]=t.default)}),o},module.exports=Utils;
},{}],3:[function(require,module,exports){
function Router(t){this.options="object"==typeof t?t:{},this.useRoutes=[],this.methodRoutes={},this.index=0,this.UrlPattern=UrlPattern}var UrlPattern=require("url-pattern");Router.prototype.route=function(){function t(){var r=a.shift();void 0!==r?(e.params=r.params,e.match=r.path,"function"==typeof r.handler?r.handler(e,o,t):Router._isRouter(r.handler)?r.handler.route(e.method,"/"+e.params._,e,o,t):t()):"function"==typeof n&&n()}if(3==arguments.length)var e={},o=arguments[2];else if(arguments.length>=4){var e=arguments[2];"object"==typeof e&&e||(e={});var o=arguments[3]}e.method=arguments[0];var r=arguments[1];void 0===e.path&&(e.path=r);var n=arguments[4],a=this._methodPathMatches(e.method,r);t()},Router.prototype.path=function(t,e){return"object"==typeof e&&null!=e||(e={}),new UrlPattern(t+"(/*)",this.options).stringify(e)},Router.prototype.use=function(){var t="string"==typeof arguments[0]?arguments[0]:"",e=Router._validHandler(arguments[0])?arguments[0]:arguments[1];return this._addRouteToArray(this.useRoutes,Router._normalizePath(t),e)},Router.prototype.useFirst=function(){var t="string"==typeof arguments[0]?arguments[0]:"",e=Router._validHandler(arguments[0])?arguments[0]:arguments[1];return this._addRouteToArray(this.useRoutes,Router._normalizePath(t),e,!0)},Router.prototype.method=function(t,e,o){return this.methodRoutes[t]instanceof Array||(this.methodRoutes[t]=[]),this._addRouteToArray(this.methodRoutes[t],Router._normalizePath(e),o)},Router._validHandler=function(t){return"function"==typeof t||Router._isRouter(t)},Router._isRouter=function(t){return"object"==typeof t&&"function"==typeof t.route},Router._normalizePath=function(t){return t.replace(/\/$/,"")},Router.prototype._methodPathMatches=function(t,e){var o=Router._normalizePath(e),r=[],n=this;return n.useRoutes.forEach(function(t){var e=new UrlPattern(t.path+"(/*)",n.options).match(o);null!==e&&r.push({path:t.path,handler:t.handler,params:e})}),n.methodRoutes[t]instanceof Array&&n.methodRoutes[t].forEach(function(t){var e=new UrlPattern(t.path,n.options).match(o);null!==e&&r.push({path:t.path,handler:t.handler,params:e})}),r},Router.prototype._addRouteToArray=function(t,e,o,r){var n={path:e,handler:o};"boolean"==typeof r?t.unshift(n):t.push(n)},module.exports=function(t){return new Router(t)};
},{"url-pattern":54}],4:[function(require,module,exports){
function AgnosticRpc(){this._requests={}}var Utils=require("./Utils");AgnosticRpc.prototype.request=function(){var e=Utils.parseArgs(arguments,[{name:"query",level:0,validate:function(e,t){return void 0!==e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),t={multipleResponses:!1},s=Utils.objectMerge(t,e.options);if("function"==typeof e.callback){var n=Utils.uniqueId();this._requests[n]={callback:e.callback,options:s}}var o={query:e.query};return void 0!==n&&(o.id=n),o},AgnosticRpc.prototype.handleResponse=function(e){if("string"==typeof e.id&&"object"==typeof this._requests[e.id]){var t=this._requests[e.id];"function"==typeof t.callback&&t.callback(null,e.response),t.options.multipleResponses||delete this._requests[e.id]}},AgnosticRpc.prototype.handleRequest=function(e,t,s){var n=function(t){var n={response:t};"string"==typeof e.id&&(n.id=e.id),s(n)};t(e.query,n)},AgnosticRpc.prototype.messageIsResponse=function(e){return void 0!==e.response},AgnosticRpc.prototype.messageIsRequest=function(e){return!this.messageIsResponse(e)},module.exports=function(){return new AgnosticRpc};
},{"./Utils":5}],5:[function(require,module,exports){
var Utils={};Utils.objectForEach=function(r,t){var e;for(e in r)r.hasOwnProperty(e)&&t(r[e],e,r)},Utils.objectMerge=function(){var r={};return this.objectForEach(arguments,function(t){for(var e in t)t.hasOwnProperty(e)&&(r[e]=t[e])}),r},Utils.uniqueId=function(){function r(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return r()+r()+"-"+r()+"-"+r()+"-"+r()+"-"+r()+r()+r()},Utils.parseArgs=function(r,t){function e(r,t){return"function"!=typeof r.validate||r.validate(t)}function n(r,t){for(var e=t;e<r.length;e++)if(void 0===r[e]||!r[e].required)return!0;return!1}var i={},a=0;return Array.isArray(r)||(r=Array.prototype.slice.call(r)),r.forEach(function(r,o){for(var u=a;u<t.length;u++){if(t[u].required){if(e(t[u],r)){t[u].matched=!0,i[t[u].name]=r,a++;break}throw"missing_required"}if(!t[u].required&&(n(t,u)||t[u].level>t[u-1].level&&t[u-1].matched)&&e(t[u],r)){t[u].matched=!0,i[t[u].name]=r,a++;break}t[u].matched=!1,a++}}),t.forEach(function(r){void 0===i[r.name]&&void 0!==r.default&&(i[r.name]=r.default)}),i},module.exports=Utils;
},{}],6:[function(require,module,exports){
var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(t){"use strict";function r(t){var r=t.charCodeAt(0);return r===h||r===u?62:r===c||r===f?63:r<o?-1:r<o+10?r-o+26+26:r<i+26?r-i:r<A+26?r-A+26:void 0}function e(t){function e(t){i[f++]=t}var n,h,c,o,A,i;if(t.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var u=t.length;A="="===t.charAt(u-2)?2:"="===t.charAt(u-1)?1:0,i=new a(3*t.length/4-A),c=A>0?t.length-4:t.length;var f=0;for(n=0,h=0;n<c;n+=4,h+=3)o=r(t.charAt(n))<<18|r(t.charAt(n+1))<<12|r(t.charAt(n+2))<<6|r(t.charAt(n+3)),e((16711680&o)>>16),e((65280&o)>>8),e(255&o);return 2===A?(o=r(t.charAt(n))<<2|r(t.charAt(n+1))>>4,e(255&o)):1===A&&(o=r(t.charAt(n))<<10|r(t.charAt(n+1))<<4|r(t.charAt(n+2))>>2,e(o>>8&255),e(255&o)),i}function n(t){function r(t){return lookup.charAt(t)}var e,n,a,h=t.length%3,c="";for(e=0,a=t.length-h;e<a;e+=3)n=(t[e]<<16)+(t[e+1]<<8)+t[e+2],c+=function(t){return r(t>>18&63)+r(t>>12&63)+r(t>>6&63)+r(63&t)}(n);switch(h){case 1:n=t[t.length-1],c+=r(n>>2),c+=r(n<<4&63),c+="==";break;case 2:n=(t[t.length-2]<<8)+t[t.length-1],c+=r(n>>10),c+=r(n>>4&63),c+=r(n<<2&63),c+="="}return c}var a="undefined"!=typeof Uint8Array?Uint8Array:Array,h="+".charCodeAt(0),c="/".charCodeAt(0),o="0".charCodeAt(0),A="a".charCodeAt(0),i="A".charCodeAt(0),u="-".charCodeAt(0),f="_".charCodeAt(0);t.toByteArray=e,t.fromByteArray=n}("undefined"==typeof exports?this.base64js={}:exports);
},{}],7:[function(require,module,exports){
(function (global){
"use strict";function typedArraySupport(){function t(){}try{var e=new Uint8Array(1);return e.foo=function(){return 42},e.constructor=t,42===e.foo()&&e.constructor===t&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(t){return!1}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function Buffer(t){return this instanceof Buffer?(Buffer.TYPED_ARRAY_SUPPORT||(this.length=0,this.parent=void 0),"number"==typeof t?fromNumber(this,t):"string"==typeof t?fromString(this,t,arguments.length>1?arguments[1]:"utf8"):fromObject(this,t)):arguments.length>1?new Buffer(t,arguments[1]):new Buffer(t)}function fromNumber(t,e){if(t=allocate(t,e<0?0:0|checked(e)),!Buffer.TYPED_ARRAY_SUPPORT)for(var r=0;r<e;r++)t[r]=0;return t}function fromString(t,e,r){return"string"==typeof r&&""!==r||(r="utf8"),t=allocate(t,0|byteLength(e,r)),t.write(e,r),t}function fromObject(t,e){if(Buffer.isBuffer(e))return fromBuffer(t,e);if(isArray(e))return fromArray(t,e);if(null==e)throw new TypeError("must start with number, buffer, array or string");if("undefined"!=typeof ArrayBuffer){if(e.buffer instanceof ArrayBuffer)return fromTypedArray(t,e);if(e instanceof ArrayBuffer)return fromArrayBuffer(t,e)}return e.length?fromArrayLike(t,e):fromJsonObject(t,e)}function fromBuffer(t,e){var r=0|checked(e.length);return t=allocate(t,r),e.copy(t,0,0,r),t}function fromArray(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;n<r;n+=1)t[n]=255&e[n];return t}function fromTypedArray(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;n<r;n+=1)t[n]=255&e[n];return t}function fromArrayBuffer(t,e){return Buffer.TYPED_ARRAY_SUPPORT?(e.byteLength,t=Buffer._augment(new Uint8Array(e))):t=fromTypedArray(t,new Uint8Array(e)),t}function fromArrayLike(t,e){var r=0|checked(e.length);t=allocate(t,r);for(var n=0;n<r;n+=1)t[n]=255&e[n];return t}function fromJsonObject(t,e){var r,n=0;"Buffer"===e.type&&isArray(e.data)&&(r=e.data,n=0|checked(r.length)),t=allocate(t,n);for(var f=0;f<n;f+=1)t[f]=255&r[f];return t}function allocate(t,e){return Buffer.TYPED_ARRAY_SUPPORT?(t=Buffer._augment(new Uint8Array(e)),t.__proto__=Buffer.prototype):(t.length=e,t._isBuffer=!0),0!==e&&e<=Buffer.poolSize>>>1&&(t.parent=rootParent),t}function checked(t){if(t>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|t}function SlowBuffer(t,e){if(!(this instanceof SlowBuffer))return new SlowBuffer(t,e);var r=new Buffer(t,e);return delete r.parent,r}function byteLength(t,e){"string"!=typeof t&&(t=""+t);var r=t.length;if(0===r)return 0;for(var n=!1;;)switch(e){case"ascii":case"binary":case"raw":case"raws":return r;case"utf8":case"utf-8":return utf8ToBytes(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return base64ToBytes(t).length;default:if(n)return utf8ToBytes(t).length;e=(""+e).toLowerCase(),n=!0}}function slowToString(t,e,r){var n=!1;if(e|=0,r=void 0===r||r===1/0?this.length:0|r,t||(t="utf8"),e<0&&(e=0),r>this.length&&(r=this.length),r<=e)return"";for(;;)switch(t){case"hex":return hexSlice(this,e,r);case"utf8":case"utf-8":return utf8Slice(this,e,r);case"ascii":return asciiSlice(this,e,r);case"binary":return binarySlice(this,e,r);case"base64":return base64Slice(this,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,e,r);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}function hexWrite(t,e,r,n){r=Number(r)||0;var f=t.length-r;n?(n=Number(n))>f&&(n=f):n=f;var i=e.length;if(i%2!=0)throw new Error("Invalid hex string");n>i/2&&(n=i/2);for(var o=0;o<n;o++){var u=parseInt(e.substr(2*o,2),16);if(isNaN(u))throw new Error("Invalid hex string");t[r+o]=u}return o}function utf8Write(t,e,r,n){return blitBuffer(utf8ToBytes(e,t.length-r),t,r,n)}function asciiWrite(t,e,r,n){return blitBuffer(asciiToBytes(e),t,r,n)}function binaryWrite(t,e,r,n){return asciiWrite(t,e,r,n)}function base64Write(t,e,r,n){return blitBuffer(base64ToBytes(e),t,r,n)}function ucs2Write(t,e,r,n){return blitBuffer(utf16leToBytes(e,t.length-r),t,r,n)}function base64Slice(t,e,r){return 0===e&&r===t.length?base64.fromByteArray(t):base64.fromByteArray(t.slice(e,r))}function utf8Slice(t,e,r){r=Math.min(t.length,r);for(var n=[],f=e;f<r;){var i=t[f],o=null,u=i>239?4:i>223?3:i>191?2:1;if(f+u<=r){var s,a,h,c;switch(u){case 1:i<128&&(o=i);break;case 2:s=t[f+1],128==(192&s)&&(c=(31&i)<<6|63&s)>127&&(o=c);break;case 3:s=t[f+1],a=t[f+2],128==(192&s)&&128==(192&a)&&(c=(15&i)<<12|(63&s)<<6|63&a)>2047&&(c<55296||c>57343)&&(o=c);break;case 4:s=t[f+1],a=t[f+2],h=t[f+3],128==(192&s)&&128==(192&a)&&128==(192&h)&&(c=(15&i)<<18|(63&s)<<12|(63&a)<<6|63&h)>65535&&c<1114112&&(o=c)}}null===o?(o=65533,u=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|1023&o),n.push(o),f+=u}return decodeCodePointsArray(n)}function decodeCodePointsArray(t){var e=t.length;if(e<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,t);for(var r="",n=0;n<e;)r+=String.fromCharCode.apply(String,t.slice(n,n+=MAX_ARGUMENTS_LENGTH));return r}function asciiSlice(t,e,r){var n="";r=Math.min(t.length,r);for(var f=e;f<r;f++)n+=String.fromCharCode(127&t[f]);return n}function binarySlice(t,e,r){var n="";r=Math.min(t.length,r);for(var f=e;f<r;f++)n+=String.fromCharCode(t[f]);return n}function hexSlice(t,e,r){var n=t.length;(!e||e<0)&&(e=0),(!r||r<0||r>n)&&(r=n);for(var f="",i=e;i<r;i++)f+=toHex(t[i]);return f}function utf16leSlice(t,e,r){for(var n=t.slice(e,r),f="",i=0;i<n.length;i+=2)f+=String.fromCharCode(n[i]+256*n[i+1]);return f}function checkOffset(t,e,r){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>r)throw new RangeError("Trying to access beyond buffer length")}function checkInt(t,e,r,n,f,i){if(!Buffer.isBuffer(t))throw new TypeError("buffer must be a Buffer instance");if(e>f||e<i)throw new RangeError("value is out of bounds");if(r+n>t.length)throw new RangeError("index out of range")}function objectWriteUInt16(t,e,r,n){e<0&&(e=65535+e+1);for(var f=0,i=Math.min(t.length-r,2);f<i;f++)t[r+f]=(e&255<<8*(n?f:1-f))>>>8*(n?f:1-f)}function objectWriteUInt32(t,e,r,n){e<0&&(e=4294967295+e+1);for(var f=0,i=Math.min(t.length-r,4);f<i;f++)t[r+f]=e>>>8*(n?f:3-f)&255}function checkIEEE754(t,e,r,n,f,i){if(e>f||e<i)throw new RangeError("value is out of bounds");if(r+n>t.length)throw new RangeError("index out of range");if(r<0)throw new RangeError("index out of range")}function writeFloat(t,e,r,n,f){return f||checkIEEE754(t,e,r,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(t,e,r,n,23,4),r+4}function writeDouble(t,e,r,n,f){return f||checkIEEE754(t,e,r,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(t,e,r,n,52,8),r+8}function base64clean(t){if(t=stringtrim(t).replace(INVALID_BASE64_RE,""),t.length<2)return"";for(;t.length%4!=0;)t+="=";return t}function stringtrim(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function toHex(t){return t<16?"0"+t.toString(16):t.toString(16)}function utf8ToBytes(t,e){e=e||1/0;for(var r,n=t.length,f=null,i=[],o=0;o<n;o++){if((r=t.charCodeAt(o))>55295&&r<57344){if(!f){if(r>56319){(e-=3)>-1&&i.push(239,191,189);continue}if(o+1===n){(e-=3)>-1&&i.push(239,191,189);continue}f=r;continue}if(r<56320){(e-=3)>-1&&i.push(239,191,189),f=r;continue}r=65536+(f-55296<<10|r-56320)}else f&&(e-=3)>-1&&i.push(239,191,189);if(f=null,r<128){if((e-=1)<0)break;i.push(r)}else if(r<2048){if((e-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(r<65536){if((e-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return i}function asciiToBytes(t){for(var e=[],r=0;r<t.length;r++)e.push(255&t.charCodeAt(r));return e}function utf16leToBytes(t,e){for(var r,n,f,i=[],o=0;o<t.length&&!((e-=2)<0);o++)r=t.charCodeAt(o),n=r>>8,f=r%256,i.push(f),i.push(n);return i}function base64ToBytes(t){return base64.toByteArray(base64clean(t))}function blitBuffer(t,e,r,n){for(var f=0;f<n&&!(f+r>=e.length||f>=t.length);f++)e[f+r]=t[f];return f}var base64=require("base64-js"),ieee754=require("ieee754"),isArray=require("isarray");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var rootParent={};Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:typedArraySupport(),Buffer.TYPED_ARRAY_SUPPORT?(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array):(Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0),Buffer.isBuffer=function(t){return!(null==t||!t._isBuffer)},Buffer.compare=function(t,e){if(!Buffer.isBuffer(t)||!Buffer.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var r=t.length,n=e.length,f=0,i=Math.min(r,n);f<i&&t[f]===e[f];)++f;return f!==i&&(r=t[f],n=e[f]),r<n?-1:n<r?1:0},Buffer.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(t,e){if(!isArray(t))throw new TypeError("list argument must be an Array of Buffers.");if(0===t.length)return new Buffer(0);var r;if(void 0===e)for(e=0,r=0;r<t.length;r++)e+=t[r].length;var n=new Buffer(e),f=0;for(r=0;r<t.length;r++){var i=t[r];i.copy(n,f),f+=i.length}return n},Buffer.byteLength=byteLength,Buffer.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?utf8Slice(this,0,t):slowToString.apply(this,arguments)},Buffer.prototype.equals=function(t){if(!Buffer.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===Buffer.compare(this,t)},Buffer.prototype.inspect=function(){var t="",e=exports.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,e).match(/.{2}/g).join(" "),this.length>e&&(t+=" ... ")),"<Buffer "+t+">"},Buffer.prototype.compare=function(t){if(!Buffer.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?0:Buffer.compare(this,t)},Buffer.prototype.indexOf=function(t,e){function r(t,e,r){for(var n=-1,f=0;r+f<t.length;f++)if(t[r+f]===e[-1===n?0:f-n]){if(-1===n&&(n=f),f-n+1===e.length)return r+n}else n=-1;return-1}if(e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e>>=0,0===this.length)return-1;if(e>=this.length)return-1;if(e<0&&(e=Math.max(this.length+e,0)),"string"==typeof t)return 0===t.length?-1:String.prototype.indexOf.call(this,t,e);if(Buffer.isBuffer(t))return r(this,t,e);if("number"==typeof t)return Buffer.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,t,e):r(this,[t],e);throw new TypeError("val must be string, number or Buffer")},Buffer.prototype.get=function(t){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(t)},Buffer.prototype.set=function(t,e){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(t,e)},Buffer.prototype.write=function(t,e,r,n){if(void 0===e)n="utf8",r=this.length,e=0;else if(void 0===r&&"string"==typeof e)n=e,r=this.length,e=0;else if(isFinite(e))e|=0,isFinite(r)?(r|=0,void 0===n&&(n="utf8")):(n=r,r=void 0);else{var f=n;n=e,e=0|r,r=f}var i=this.length-e;if((void 0===r||r>i)&&(r=i),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return hexWrite(this,t,e,r);case"utf8":case"utf-8":return utf8Write(this,t,e,r);case"ascii":return asciiWrite(this,t,e,r);case"binary":return binaryWrite(this,t,e,r);case"base64":return base64Write(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,t,e,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;Buffer.prototype.slice=function(t,e){var r=this.length;t=~~t,e=void 0===e?r:~~e,t<0?(t+=r)<0&&(t=0):t>r&&(t=r),e<0?(e+=r)<0&&(e=0):e>r&&(e=r),e<t&&(e=t);var n;if(Buffer.TYPED_ARRAY_SUPPORT)n=Buffer._augment(this.subarray(t,e));else{var f=e-t;n=new Buffer(f,void 0);for(var i=0;i<f;i++)n[i]=this[i+t]}return n.length&&(n.parent=this.parent||this),n},Buffer.prototype.readUIntLE=function(t,e,r){t|=0,e|=0,r||checkOffset(t,e,this.length);for(var n=this[t],f=1,i=0;++i<e&&(f*=256);)n+=this[t+i]*f;return n},Buffer.prototype.readUIntBE=function(t,e,r){t|=0,e|=0,r||checkOffset(t,e,this.length);for(var n=this[t+--e],f=1;e>0&&(f*=256);)n+=this[t+--e]*f;return n},Buffer.prototype.readUInt8=function(t,e){return e||checkOffset(t,1,this.length),this[t]},Buffer.prototype.readUInt16LE=function(t,e){return e||checkOffset(t,2,this.length),this[t]|this[t+1]<<8},Buffer.prototype.readUInt16BE=function(t,e){return e||checkOffset(t,2,this.length),this[t]<<8|this[t+1]},Buffer.prototype.readUInt32LE=function(t,e){return e||checkOffset(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},Buffer.prototype.readUInt32BE=function(t,e){return e||checkOffset(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},Buffer.prototype.readIntLE=function(t,e,r){t|=0,e|=0,r||checkOffset(t,e,this.length);for(var n=this[t],f=1,i=0;++i<e&&(f*=256);)n+=this[t+i]*f;return f*=128,n>=f&&(n-=Math.pow(2,8*e)),n},Buffer.prototype.readIntBE=function(t,e,r){t|=0,e|=0,r||checkOffset(t,e,this.length);for(var n=e,f=1,i=this[t+--n];n>0&&(f*=256);)i+=this[t+--n]*f;return f*=128,i>=f&&(i-=Math.pow(2,8*e)),i},Buffer.prototype.readInt8=function(t,e){return e||checkOffset(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},Buffer.prototype.readInt16LE=function(t,e){e||checkOffset(t,2,this.length);var r=this[t]|this[t+1]<<8;return 32768&r?4294901760|r:r},Buffer.prototype.readInt16BE=function(t,e){e||checkOffset(t,2,this.length);var r=this[t+1]|this[t]<<8;return 32768&r?4294901760|r:r},Buffer.prototype.readInt32LE=function(t,e){return e||checkOffset(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},Buffer.prototype.readInt32BE=function(t,e){return e||checkOffset(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},Buffer.prototype.readFloatLE=function(t,e){return e||checkOffset(t,4,this.length),ieee754.read(this,t,!0,23,4)},Buffer.prototype.readFloatBE=function(t,e){return e||checkOffset(t,4,this.length),ieee754.read(this,t,!1,23,4)},Buffer.prototype.readDoubleLE=function(t,e){return e||checkOffset(t,8,this.length),ieee754.read(this,t,!0,52,8)},Buffer.prototype.readDoubleBE=function(t,e){return e||checkOffset(t,8,this.length),ieee754.read(this,t,!1,52,8)},Buffer.prototype.writeUIntLE=function(t,e,r,n){t=+t,e|=0,r|=0,n||checkInt(this,t,e,r,Math.pow(2,8*r),0);var f=1,i=0;for(this[e]=255&t;++i<r&&(f*=256);)this[e+i]=t/f&255;return e+r},Buffer.prototype.writeUIntBE=function(t,e,r,n){t=+t,e|=0,r|=0,n||checkInt(this,t,e,r,Math.pow(2,8*r),0);var f=r-1,i=1;for(this[e+f]=255&t;--f>=0&&(i*=256);)this[e+f]=t/i&255;return e+r},Buffer.prototype.writeUInt8=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},Buffer.prototype.writeUInt16LE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):objectWriteUInt16(this,t,e,!0),e+2},Buffer.prototype.writeUInt16BE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):objectWriteUInt16(this,t,e,!1),e+2},Buffer.prototype.writeUInt32LE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):objectWriteUInt32(this,t,e,!0),e+4},Buffer.prototype.writeUInt32BE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):objectWriteUInt32(this,t,e,!1),e+4},Buffer.prototype.writeIntLE=function(t,e,r,n){if(t=+t,e|=0,!n){var f=Math.pow(2,8*r-1);checkInt(this,t,e,r,f-1,-f)}var i=0,o=1,u=t<0?1:0;for(this[e]=255&t;++i<r&&(o*=256);)this[e+i]=(t/o>>0)-u&255;return e+r},Buffer.prototype.writeIntBE=function(t,e,r,n){if(t=+t,e|=0,!n){var f=Math.pow(2,8*r-1);checkInt(this,t,e,r,f-1,-f)}var i=r-1,o=1,u=t<0?1:0;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=(t/o>>0)-u&255;return e+r},Buffer.prototype.writeInt8=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},Buffer.prototype.writeInt16LE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):objectWriteUInt16(this,t,e,!0),e+2},Buffer.prototype.writeInt16BE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):objectWriteUInt16(this,t,e,!1),e+2},Buffer.prototype.writeInt32LE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):objectWriteUInt32(this,t,e,!0),e+4},Buffer.prototype.writeInt32BE=function(t,e,r){return t=+t,e|=0,r||checkInt(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),Buffer.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):objectWriteUInt32(this,t,e,!1),e+4},Buffer.prototype.writeFloatLE=function(t,e,r){return writeFloat(this,t,e,!0,r)},Buffer.prototype.writeFloatBE=function(t,e,r){return writeFloat(this,t,e,!1,r)},Buffer.prototype.writeDoubleLE=function(t,e,r){return writeDouble(this,t,e,!0,r)},Buffer.prototype.writeDoubleBE=function(t,e,r){return writeDouble(this,t,e,!1,r)},Buffer.prototype.copy=function(t,e,r,n){if(r||(r=0),n||0===n||(n=this.length),e>=t.length&&(e=t.length),e||(e=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-e<n-r&&(n=t.length-e+r);var f,i=n-r;if(this===t&&r<e&&e<n)for(f=i-1;f>=0;f--)t[f+e]=this[f+r];else if(i<1e3||!Buffer.TYPED_ARRAY_SUPPORT)for(f=0;f<i;f++)t[f+e]=this[f+r];else t._set(this.subarray(r,r+i),e);return i},Buffer.prototype.fill=function(t,e,r){if(t||(t=0),e||(e=0),r||(r=this.length),r<e)throw new RangeError("end < start");if(r!==e&&0!==this.length){if(e<0||e>=this.length)throw new RangeError("start out of bounds");if(r<0||r>this.length)throw new RangeError("end out of bounds");var n;if("number"==typeof t)for(n=e;n<r;n++)this[n]=t;else{var f=utf8ToBytes(t.toString()),i=f.length;for(n=e;n<r;n++)this[n]=f[n%i]}return this}},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;for(var t=new Uint8Array(this.length),e=0,r=t.length;e<r;e+=1)t[e]=this[e];return t.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(t){return t.constructor=Buffer,t._isBuffer=!0,t._set=t.set,t.get=BP.get,t.set=BP.set,t.write=BP.write,t.toString=BP.toString,t.toLocaleString=BP.toString,t.toJSON=BP.toJSON,t.equals=BP.equals,t.compare=BP.compare,t.indexOf=BP.indexOf,t.copy=BP.copy,t.slice=BP.slice,t.readUIntLE=BP.readUIntLE,t.readUIntBE=BP.readUIntBE,t.readUInt8=BP.readUInt8,t.readUInt16LE=BP.readUInt16LE,t.readUInt16BE=BP.readUInt16BE,t.readUInt32LE=BP.readUInt32LE,t.readUInt32BE=BP.readUInt32BE,t.readIntLE=BP.readIntLE,t.readIntBE=BP.readIntBE,t.readInt8=BP.readInt8,t.readInt16LE=BP.readInt16LE,t.readInt16BE=BP.readInt16BE,t.readInt32LE=BP.readInt32LE,t.readInt32BE=BP.readInt32BE,t.readFloatLE=BP.readFloatLE,t.readFloatBE=BP.readFloatBE,t.readDoubleLE=BP.readDoubleLE,t.readDoubleBE=BP.readDoubleBE,t.writeUInt8=BP.writeUInt8,t.writeUIntLE=BP.writeUIntLE,t.writeUIntBE=BP.writeUIntBE,t.writeUInt16LE=BP.writeUInt16LE,t.writeUInt16BE=BP.writeUInt16BE,t.writeUInt32LE=BP.writeUInt32LE,t.writeUInt32BE=BP.writeUInt32BE,t.writeIntLE=BP.writeIntLE,t.writeIntBE=BP.writeIntBE,t.writeInt8=BP.writeInt8,t.writeInt16LE=BP.writeInt16LE,t.writeInt16BE=BP.writeInt16BE,t.writeInt32LE=BP.writeInt32LE,t.writeInt32BE=BP.writeInt32BE,t.writeFloatLE=BP.writeFloatLE,t.writeFloatBE=BP.writeFloatBE,t.writeDoubleLE=BP.writeDoubleLE,t.writeDoubleBE=BP.writeDoubleBE,t.fill=BP.fill,t.inspect=BP.inspect,t.toArrayBuffer=BP.toArrayBuffer,t};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})

},{"base64-js":6,"ieee754":27,"isarray":8}],8:[function(require,module,exports){
var toString={}.toString;module.exports=Array.isArray||function(r){return"[object Array]"==toString.call(r)};
},{}],9:[function(require,module,exports){
var getBSONType=require("./lib/GetBSONType"),MatchQuery=require("./lib/MatchQuery"),Update=require("./lib/Update"),Merge=require("./lib/Merge"),Project=require("./lib/Project"),Aggregate=require("./lib/Aggregate"),FauxmongoError=require("./lib/FauxmongoError");module.exports.matchQuery=MatchQuery,module.exports.update=Update,module.exports.merge=Merge,module.exports.project=Project,module.exports.aggregate=Aggregate,module.exports.FauxmongoError=FauxmongoError,module.exports.getBSONType=getBSONType,module.exports.resolveDollar=Update.resolveDollar;
},{"./lib/Aggregate":10,"./lib/FauxmongoError":13,"./lib/GetBSONType":14,"./lib/MatchQuery":17,"./lib/Merge":18,"./lib/Project":20,"./lib/Update":25}],10:[function(require,module,exports){
function aggregate(r,e,a){var t;a&&(t=[]);for(var o in e){var g,n=e[o];try{g=Object.keys(n)[0]}catch(r){continue}if("$out"==g){if(o!=e.length-1)throw new FauxmongoError("INVALID","found an $out stage that was not the final stage");break}var u=n[g];if(!Object.hasOwnProperty.call(StageOperators,g))throw new FauxmongoError("INVALID","unknown operator",{operator:g});r=StageOperators[g](r,u),a&&t.push(r)}return a?t:r}var StageOperators=require("./AggregationStages"),evaluate=require("./AggregationOperators").evaluate,getTypeStr=require("./GetTypeStr"),FauxmongoError=require("./FauxmongoError");module.exports=aggregate,aggregate.evaluateExpression=evaluate;
},{"./AggregationOperators":11,"./AggregationStages":12,"./FauxmongoError":13,"./GetTypeStr":15}],11:[function(require,module,exports){
function evaluate(e,r){var t=getTypeStr(e);if("string"==t){if("$"==e[0]){if("$"==e[1]){var a=e.slice(2);if(Object.hasOwnProperty.call(r,a))return r[a];throw new FauxmongoError("INVALID","variable "+e+" not found")}var n=r.CURRENT,o=e.slice(1).split(".");for(var u in o){var i=o[u];if(!Object.hasOwnProperty.call(n,i))return;n=n[i]}return n}return e}if("object"==t){var l=Object.keys(e)[0];if("$"!=l[0]){var s={};for(var l in e)s[l]=evaluate(e[l],r);return s}if("$literal"==l)return e.$literal;if("$let"==l){var f={},c=e.$let;for(var v in c.vars)Object.hasOwnProperty.call(r,v)&&(f[v]=r[v]),r[v]=evaluate(c.vars[v],r);var p=evaluate(c.in,r);for(var v in c.vars)Object.hasOwnProperty.call(f,v)?r[v]=f[v]:delete r[v];return p}if("$map"==l){var c=e.$map,f=Object.hasOwnProperty.call(r,c.as)?r[c.as]:void 0,w=evaluate(c.input,r);if(!(w instanceof Array))throw new Error("$map requires an Array input");var $=[];for(var u in w)r[c.as]=w[u],$.push(evaluate(c.in,r));return void 0!==f?r[c.as]=f:delete r[c.as],$}if(!Object.hasOwnProperty.call(AggregationOperators,l))throw new Error("unknown aggregation operator "+l);return AggregationOperators[l](e[l],r)}return e}var getTypeStr=require("./GetTypeStr"),getBSONType=require("./GetBSONType"),matchLeaves=require("./MatchQuery").matchLeaves,Sorting=require("./Sorting"),leafSorter=Sorting.getLeafsort(1),Set=require("./Set"),FauxmongoError=require("./FauxmongoError"),AggregationOperators={$and:function(e,r){for(var t in e)if(!evaluate(e[t],r))return!1;return!0},$or:function(e,r){for(var t in e)if(!evaluate(e[t],r))return!0;return!1},$not:function(e,r){return!Boolean(evaluate(e[0],r))},$allElementsTrue:function(e,r){e=e[0];var t=evaluate(e,r);if(!(t instanceof Array))throw new Error("$allElementsTrue requires an Array");for(var a in t)if(!t[a])return!1;return!0},$anyElementTrue:function(e,r){e=e[0];var t=evaluate(e,r);if(!(t instanceof Array))throw new Error("$anyElementTrue requires an Array");for(var a in t)if(t[a])return!0;return!1},$setDifference:function(e,r){var t=new Set(evaluate(e[0],r)),a=new Set(evaluate(e[1],r));return t.difference(a),t.export()},$setEquals:function(e,r){var t=[];for(var a in e){var n=evaluate(e[a],r);if(!(n instanceof Array))throw new Error("$setEquals only accepts Arrays");t.push(new Set(n))}if(t.length<2)throw new Error("$setEquals requires at least 2 sets");for(var o=t[1],a=1,u=t.length;a<u;a++)if(!o.equals(t[a]))return!1;return!0},$setIntersection:function(e,r){var t=[];for(var a in e){var n=evaluate(e[a],r);if(!(n instanceof Array))throw new Error("$setIntersection only accepts Arrays");t.push(new Set(n))}if(t.length<2)throw new Error("$setIntersection requires at least 2 sets");for(var o=t[0],a=1,u=t.length;a<u;a++)o=o.intersect(t[a]);return o.export()},$setIsSubset:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if(!(t instanceof Array&&a instanceof Array))throw new FauxmongoError("FORMAT","$setIsSubset only accepts Arrays");return t=new Set(t),a=new Set(a),a.contains(t)},$setUnion:function(e,r){var t=[];for(var a in e)t.push(new Set(evaluate(e[a],r)));if(t.length<2)throw new Error("$setIntersection requires at least 2 sets");for(var n=t[0],a=1,o=t.length;a<o;a++)n.union(t[a]);return n.export()},$cmp:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)},$eq:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return matchLeaves(t,a)},$gt:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)>0},$gte:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)>=0},$lt:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)<0},$lte:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return leafSorter(t,a)<=0},$ne:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);return!matchLeaves(t,a)},$add:function(e,r){var t=[],a=!1;for(var n in e){var o=evaluate(e[n],r),u=typeof o;if("date"==u){if(a)throw new Error("$add accepts at most 1 Date");a=o}else{if("number"!=u)throw new Error("$add only accepts Numbers and Dates");t.push(o)}}if(a){var i=a.getTime();for(var n in t)i+=t[n];return a.setTime(i),a}var l=0;for(var n in t)l+=t[n];return l},$divide:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if("number"!=typeof t||"number"!=typeof a)throw new Error("$divide only accepts Numbers");return t/a},$mod:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if("number"!=typeof t||"number"!=typeof a)throw new Error("$divide only accepts Numbers");return t%a},$multiply:function(e,r){var t=[];for(var a in e){var n=evaluate(e[a],r);if("number"!=typeof n)throw new Error("$multiply only accepts Numbers");t.push(n)}var o=1;for(var a in t)o*=t[a];return o},$subtract:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if("number"!=typeof t||"number"!=typeof a)throw new Error("$divide only accepts Numbers");return t-a},$concat:function(e,r){var t=[];for(var a in e){var n=evaluate(e[a],r);if("string"!=typeof n){if(null===n||void 0===n)return null;throw new Error("$multiply only accepts Numbers")}t.push(n)}if(t.length<2)throw new Error("$concat requires at least 2 arguments");return String.prototype.concat.apply("",t)},$strcasecmp:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r);if("string"!=typeof t||"string"!=typeof a)throw new Error("$strcasecmp only accepts Strings");return t=t.toUpperCase(),a=a.toUpperCase(),t==a?0:t<a?-1:1},$substr:function(e,r){var t=evaluate(e[0],r),a=evaluate(e[1],r),n=evaluate(e[2],r);if("string"!=typeof t||"number"!=typeof a||"number"!=typeof n)throw new Error("invalid arguments to $substr");return a<0?"":n<0?t.slice(a):t.slice(a,a+n)},$toLower:function(e,r){var t=evaluate(e,r);if(null===t)return"";if("string"!=typeof t)throw new Error("$toLower only accepts Strings");return t.toLowerCase()},$toUpper:function(e,r){var t=evaluate(e,r);if(null===t)return"";if("string"!=typeof t)throw new Error("$toUpper only accepts Strings");return t.toUpperCase()},$meta:function(e,r){throw new Error("$meta not supported")},$size:function(e,r){var t=evaluate(e,r);if(!(t instanceof Array))throw new Error("$size only accepts Arrays");return t.length},$dayOfMonth:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$dayOfMonth only accepts Dates");return e.getDate()},$dayOfWeek:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$dayOfWeek only accepts Dates");return e.getDay()%7+1},$dayOfYear:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$dayOfYear only accepts Dates");var t=new Date(e.getFullYear(),0,0),a=e-t;return Math.floor(a/864e5)},$hour:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$hour only accepts Dates");return e.getHours()},$millisecond:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$millisecond only accepts Dates");return e.getMilliseconds()},$minute:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$minute only accepts Dates");return e.getMinutes()},$month:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$month only accepts Dates");return e.getMonth()+1},$second:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$second only accepts Dates");return e.getSeconds()},$week:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$week only accepts Dates");var t=new Date(e.getTime()),a=(e.getDay()+6)%7;t.setDate(t.getDate()-a-1);var n=t.getTime();return t.setMonth(0,1),a=t.getDay(),7!=a&&t.setMonth(0,7-a),1+Math.ceil((t.getTime()-n)/6048e5)},$year:function(e,r){if(!((e=evaluate(e,r))instanceof Date))throw new Error("$year only accepts Dates");return e.getFullYear()},$cond:function(e,r){var t,a,n;if(e instanceof Array)t=e[0],a=e[1],n=e[2];else{if("object"!=typeof e)throw new Error("$cond requires either an Object or Array of arguments");t=e.if,a=e.then,n=e.else}return!0===evaluate(t,r)?evaluate(a,r):evaluate(n,r)},$ifNull:function(e,r){var t=evaluate(e[0],r);return null===t?evaluate(e[1],r):t}},AggregationAccumulators={$addToSet:function(e,r){var t=new Set;for(var a in r)t.add(evaluate(e,{CURRENT:r[a]}));return t.export()},$avg:function(e,r){var t=0,a=0;for(var n in r){var o=evaluate(e,{CURRENT:r[n]});if("number"!=typeof o)throw new FauxmongoError("FORMAT","$sum only accepts numbers");a+=o,t++}return a/t},$first:function(e,r){return evaluate(e,{CURRENT:r[0]})},$last:function(e,r){return evaluate(e,{CURRENT:r[r.length-1]})},$max:function(e,r){for(var t=evaluate(e,{CURRENT:r[0]}),a=1,n=r.length;a<n;a++){var o=evaluate(e,{CURRENT:r[a]});leafSorter(o,t)>0&&(t=o)}return t},$min:function(e,r){for(var t=evaluate(e,{CURRENT:r[0]}),a=1,n=r.length;a<n;a++){var o=evaluate(e,{CURRENT:r[a]});leafSorter(o,t)<0&&(t=o)}return t},$push:function(e,r){var t=[];for(var a in r)t.push(evaluate(e,{CURRENT:r[a]}));return t},$sum:function(e,r){var t=0;for(var a in r){var n=evaluate(e,{CURRENT:r[a]});if("number"!=typeof n)throw new FauxmongoError("FORMAT","$sum only accepts numbers");t+=n}return t}};module.exports.evaluate=evaluate,module.exports.accumulators=AggregationAccumulators;
},{"./FauxmongoError":13,"./GetBSONType":14,"./GetTypeStr":15,"./MatchQuery":17,"./Set":23,"./Sorting":24}],12:[function(require,module,exports){
function clone(r){var e={};for(var o in r){var a=r[o];"object"==typeof a?a instanceof Array?e[o]=cloneArr(a):e[o]=clone(a):e[o]=r[o]}return e}function cloneArr(r){var e=[];for(var o in r){var a=r[o];"object"==typeof a?r instanceof Array?e[o]=clone(a):e[o]=cloneArr(a):e[o]=r[o]}return e}var AggregationOperators=require("./AggregationOperators"),matchQuery=require("./MatchQuery"),project=require("./Project"),Sorting=require("./Sorting"),getTypeStr=require("./GetTypeStr"),FauxmongoError=require("./FauxmongoError"),AggregationStages={$geoNear:function(r,e){throw new FauxmongoError("SUPPORT","$geoNear is not supported")},$group:function(r,e){var o={},a={},t=[],n=[];for(var i in r){var c=r[i],s={CURRENT:c},u=AggregationOperators.evaluate(e._id,s),f=getTypeStr(u);if("string"==f)Object.hasOwnProperty.call(o,u)?o[u].push(c):o[u]=[c];else if("number"==f)Object.hasOwnProperty.call(a,u)?a[u].push(c):a[u]=[c];else{var v=!1;for(var i in t)if(matchQuery.matchLeaves(u,t[i])){v=!0,n[i].push(c);break}v||(t.push(u),n.push([c]))}}var p=t,g=n,l=Object.keys(o),h=Object.keys(a);p.push.apply(p,l),p.push.apply(p,h);for(var i in l)g.push(o[l[i]]);for(var i in h)g.push(a[h[i]]);var y=[];for(var i in p){var O=p[i],E=g[i],w={_id:O};for(var b in e)if("_id"!=b){var j=e[b],A=Object.keys(j);if(!A.length||!Object.hasOwnProperty.call(AggregationOperators.accumulators,A[0]))throw new FauxmongoError("INVALID","$group found an invalid aggregation spec");Object.hasOwnProperty.call(w,b)&&w[b];w[b]=AggregationOperators.accumulators[A[0]](j[A[0]],E)}y.push(w)}return y},$limit:function(r,e){return r.slice(0,e)},$match:function(r,e){for(var o=[],a=0,t=r.length;a<t;a++)matchQuery(r[a],e)&&o.push(r[a]);return o},$project:function(r,e){var o=[];for(var a in r){var t=r[a],n={CURRENT:t},i=!1,c=!1,s={};for(var u in e){if("_id"==u){var f=e[u];if(0===f||!1===f)continue}var v=e[u];if("object"!=typeof v||v instanceof Array){var p,g=1!==v&&!0!==v,l=r[a],h=s,y=u.split(".");if(y.length>1&&i)throw new FauxmongoError("$project cannot combine dot-notation and layered spec","INVALID");c=!0;for(var O=!1,E=0,w=y.length-1;E<w;E++){var b=y[E];if(Object.hasOwnProperty.call(l,b))l=l[b];else if(!g){O=!0;break}Object.hasOwnProperty.call(h,b)||(l[b]instanceof Array?h[b]=[]:h[b]={}),h=h[b]}O||(p=y[y.length-1],g?h[p]=AggregationOperators.evaluate(v,n):Object.hasOwnProperty.call(l,p)&&(h[p]=l[p]))}else{var j=Object.keys(v);if(j[0]&&"$"==j[0][0]){s[u]=evaluate(v,n);continue}if(c)throw new FauxmongoError("INVALID","$project cannot combine dot-notation and layered spec");i=!0;var A=Object.hasOwnProperty.call(t,u)?t[u]:void 0,$=function r(e,o){var a={},t=!1;for(var i in o){var c=o[i];if("object"!=typeof c||c instanceof Array)1===c||!0===c?e&&Object.hasOwnProperty.call(e,i)&&(a[i]=e[i],t=!0):(a[i]=AggregationOperators.evaluate(c,n),t=!0);else{var s=Object.keys(c);if(s[0]&&"$"==s[0][0])a[i]=AggregationOperators.evaluate(c,n),t=!0;else for(var u in s){var f=s[u],v=e&&Object.hasOwnProperty.call(e,f)?e[f]:void 0,p=r(v,c[f],a[f]={});void 0!==p&&(t=!0,a[f]=p)}}}if(t)return a}(A,v);void 0!==$&&(s[u]=$)}}o.push(s)}return o},$redact:function(r,e){var o=[];for(var a in r){var t=r[a],n={CURRENT:t,DESCEND:{},KEEP:{},PRUNE:{}},i=AggregationOperators.evaluate(e,n);if(i!==n.PRUNE)if(i!==n.KEEP){if(i!==n.DESCEND)throw new FauxmongoError("INVALID","$redact expects one of $$PRUNE, $$KEEP, $$DESCEND");newDoc={};for(var c in t){var s=t[c];if("object"==typeof s){var u=function r(o){if(o instanceof Array){var a=[];for(var t in o){var i=o[t];if("object"!=typeof i)a.push(i);else{var c=r(i);void 0!==c&&a.push(c)}}if(a.length)return a}else{n.CURRENT=o;var s=AggregationOperators.evaluate(e,n);if(s!==n.PRUNE){if(s===n.KEEP)return o;if(s!==n.DESCEND)throw new FauxmongoError("INVALID","$redact expects one of $$PRUNE, $$KEEP, $$DESCEND");var a={},u=Object.keys(o);for(var t in u){var f=u[t],i=o[f];if("object"!=typeof i)a[f]=i;else{var c=r(i);void 0!==c&&(a[f]=c)}}return Object.keys(a).length?a:void 0}}}(s,newDoc);void 0!==u&&(newDoc[c]=u)}else newDoc[c]=t[c]}o.push(newDoc)}else o.push(t)}return o},$skip:function(r,e){return r.slice(e)},$sort:function(r,e){var o=[];return o.push.apply(o,r),o.sort(Sorting.getDocsort(e)),o},$unwind:function(r,e){for(var o=[],a=e.slice(1).split("."),t=0,n=r.length;t<n;t++){var i=r[t],c=r[t],s=!1;for(var u in a){var f=a[u];if(!Object.hasOwnProperty.call(c,f)){s=!0;break}if("object"!=typeof(c=c[f]))throw new FauxmongoError("FORMAT","$unwind found something other than an Array")}if(!s){if(!(c instanceof Array))throw new FauxmongoError("FORMAT","$unwind found something other than an Array");var v=[];for(var u in c){newDoc=clone(i);for(var p=newDoc,g=0,l=a.length-1;g<l;g++)p=p[a[g]];p[a[a.length-1]]=c[u],v.push(newDoc)}o.push.apply(o,v)}}return o}};module.exports=AggregationStages;
},{"./AggregationOperators":11,"./FauxmongoError":13,"./GetTypeStr":15,"./MatchQuery":17,"./Project":20,"./Sorting":24}],13:[function(require,module,exports){
function FauxmongoError(r,o,i){if(Error.call(this),this.code=r,this.message=o,i)for(var t in i)this[t]=i[t]}var util=require("util");util.inherits(FauxmongoError,Error),module.exports=FauxmongoError;
},{"util":57}],14:[function(require,module,exports){
function getBSONType(S,E){var N=getTypeStr(S);return"number"==N?E?1:Math.round(S)==S?16:1:BSON_TYPES.hasOwnProperty(N)?BSON_TYPES[N]:0}var BSON_TYPES={};BSON_TYPES.DOUBLE=1,BSON_TYPES.STRING=2,BSON_TYPES.OBJECT=3,BSON_TYPES.ARRAY=4,BSON_TYPES.BUFFER=5,BSON_TYPES.UNDEFINED=6,BSON_TYPES.OBJECT_ID=7,BSON_TYPES.BOOLEAN=8,BSON_TYPES.DATE=9,BSON_TYPES.NULL=10,BSON_TYPES.REGEXP=11,BSON_TYPES.FUNCTION=13,BSON_TYPES.INTEGER=16,BSON_TYPES.LONG=18,module.exports.BSON_TYPES=BSON_TYPES,module.exports=getBSONType;
},{}],15:[function(require,module,exports){
(function (Buffer){
function getTypeStr(e){var t=typeGetter.apply(e).slice(8,-1).toLowerCase();return"object"==t?e instanceof Buffer?"buffer":t:"text"==t?"textnode":"comment"==t?"commentnode":"html"==t.slice(0,4)?"element":t}var typeGetter={}.toString;try{Buffer}catch(e){Buffer=function(){}}module.exports=getTypeStr;
}).call(this,require("buffer").Buffer)

},{"buffer":7}],16:[function(require,module,exports){
function matchLeaves(e,r){if(e===r)return!0;var t=getTypeStr(e);if(t!=getTypeStr(r))return!1;if("array"==t){if(e.length!=r.length)return!1;for(var a in e)if(!matchLeaves(e[a],r[a]))return!1;return!0}if("object"==t){var n=Object.keys(e);if(n.length!=Object.keys(r).length)return!1;for(var a in n){var i=n[a];if(!Object.hasOwnProperty.call(r,i)||!matchLeaves(e[i],r[i]))return!1}return!0}return!1}var getTypeStr=require("./GetTypeStr");module.exports=matchLeaves;
},{"./GetTypeStr":15}],17:[function(require,module,exports){
function matchQuery(r,e,a){var t=a?a.length:0;for(var i in e){var o=e[i];if(a){if(i.slice(0,t)!=a)continue;i=i.slice(t+1)}if("$where"==i)throw new Error("$where is not supported");var n=getTypeStr(o);if("$and"!=i)if("$or"!=i)if("$nor"!=i){if("$"==i[0])return matchSubquery(r,e);for(var f=i.split("."),h=r,u="object",c=!0,s=!1,l=0,y=f.length-1;l<y;l++){var v=f[l];if("$"==v[0])throw new Error("invalid path "+i);if("array"==u){var m=parseInt(v),p=f.slice(l+1).join(".");if(!isNaN(m)&&v.match(/^\d+$/)&&m<h.length){var w={};if(w[p]=o,matchQuery(h[v],w)){s=!0;break}}var b=!1;p=v+"."+p;var w={};w[p]=o;for(var l in h)if(matchQuery(h[l],w)){b=!0;break}if(!b)return!1;s=!0;break}if("object"!=u)throw new Error("Encountered a leaf in the middle of the path "+i);if("$"==v[0])throw new Error("invalid path "+i);if(!Object.hasOwnProperty.call(h,v)){c=!1;break}h=h[v],u=getTypeStr(h)}if(!s){var v=f[f.length-1];if("$"==v[0])throw new Error("invalid path "+i);if("array"==u){var m=parseInt(v),p=f.slice(l+1).join(".");if(!isNaN(m)&&v.match(/^\d+$/)&&m<h.length&&matchLeaves(h[v],o)){s=!0;break}var b=!1,w={};w[v]=o;for(var l in h)if(matchQuery(h[l],w)){b=!0;break}if(!b)return!1;s=!0;break}if("object"!=u)throw new Error("Encountered a leaf in the middle of the path "+i);if(!c||!Object.hasOwnProperty.call(h,v)){if("object"==n&&Object.hasOwnProperty.call(o,"$exists")&&!o.$exists)continue;return!1}if("object"!=n||!moreDollars(o)){if(matchLeaves(h[v],o))continue;return!1}for(var d in o)if("$exists"!=d&&!operators.ops[d](h[v],o[d]))return!1}}else{if("array"!=n)throw new Error("$nor requires an Array of query documents");for(var l=0,y=o.length;l<y;l++)if(matchQuery(r,o[l]))return!1}else{if("array"!=n)throw new Error("$or requires an Array of query documents");for(var b=!1,l=0,y=o.length;l<y;l++)if(matchQuery(r,o[l])){b=!0;break}if(!b)return!1}else{if("array"!=n)throw new Error("$and requires an Array of query documents");for(var l=0,y=o.length;l<y;l++)if(!matchQuery(r,o[l]))return!1}}return!0}function matchSubquery(r,e){for(var a in e)if("$exists"!=a&&!operators.ops[a](r,e[a]))return!1;return!0}module.exports=matchQuery,matchQuery.matchSubquery=matchSubquery;var operators=require("./QueryOperators"),getTypeStr=require("./GetTypeStr"),moreDollars=require("./MoreDollars"),matchLeaves=require("./MatchLeaves");matchQuery.matchLeaves=matchLeaves;
},{"./GetTypeStr":15,"./MatchLeaves":16,"./MoreDollars":19,"./QueryOperators":21}],18:[function(require,module,exports){
function simpleMerge(e,r){for(var t in e){var i=e[t];if(Object.hasOwnProperty.call(r,t)){var a=getTypeStr(i),l=r[t];a==getTypeStr(l)?"object"==a?simpleMerge(i,l):"array"==a?simpleArrayMerge(i,l):r[t]=i:r[t]=i}else r[t]=i}}function simpleArrayMerge(e,r){for(var t in e){var i=e[t];if(t>=r.length)r.push(i);else{var a=getTypeStr(i),l=r[t];a==getTypeStr(l)?"object"==a?simpleMerge(i,l):"array"==a?simpleArrayMerge(i,l):r[t]=i:r[t]=i}}}function merge(e,r,t,i){function a(e,r,t){for(var i in e){var o=e[i],n=getTypeStr(o),s=t?t+"."+i:i;if(Object.hasOwnProperty.call(r,i)){var c=r[i];n==getTypeStr(c)?"object"==n?a(o,c,s):"array"==n?l(o,c,s):r[i]=o:r[i]=o}else if("array"!=n)r[i]=o;else{var p=r[i]=[];l(o,p,s)}}}function l(e,n,s){if(e.length){if(Object.hasOwnProperty.call(i,s)){var c=i[s];if("object"==typeof c){if(c.$elemMatch){for(var p in n)if(matchQuery(n[p],c.$elemMatch))return void(n[p]=e[0]);return}if(c.$slice){var f,v,y;if("number"==typeof c.$slice){if(c.$slice<0)return;f=0,v=Math.min(e.length,c.$slice)}else{if(c.$slice[0]<0)return;f=c.$slice[0],v=f+c.$slice[1],y=v-f-e.length}for(var p=0,g=f;g<v;g++,p++)n[g]=e[p];return void(y&&n.splice(f+e.length,n.length))}}}else if(Object.hasOwnProperty.call(i,s+".$")){if(o)throw new Error("projection contains more than one positional operator");o=s;var u=resolveDollar(r,t,s.split("."),s);return void(u>=0&&(n[u]=e[0]))}for(var p in e){var h=e[p];if(p>=n.length)n.push(h);else{var m=getTypeStr(h),M=n[p];m==getTypeStr(M)?"object"==m?a(h,M,s):"array"==m?l(h,M,s):n[p]=h:n[p]=h}}}}if(i||(i=t,t=void 0),!i)return simpleMerge(e,r);var o;a(e,r)}var getTypeStr=require("./GetTypeStr"),resolveDollar=require("./ResolveDollar"),matchQuery=require("./MatchQuery");module.exports=merge;
},{"./GetTypeStr":15,"./MatchQuery":17,"./ResolveDollar":22}],19:[function(require,module,exports){
function moreDollars(r,e){if(e){for(var o in r)if(moreDollars(r[o]))return!0;return!1}for(var t in r){if("$"==t[0])return!0;var l=r[t],a=getTypeStr(l);if("object"!=a){if("array"==a&&moreDollars(l,!0))return!0}else if(moreDollars(l))return!0}return!1}var getTypeStr=require("./GetTypeStr");module.exports=moreDollars;
},{"./GetTypeStr":15}],20:[function(require,module,exports){
function project(r,e,a){function o(r,e,a){var i,t=getTypeStr(r);if(e)i=e;else{if("object"!=t){if("array"==t){e=[];var n=a.slice(l);for(var l in r){var s=o(r[l],e[l],n);void 0!==s&&(e[l]=s)}return e}return}e={}}for(var l=0,c=a.length-1;l<c;l++){var f=a[l];if("$"==f)throw new Error("cannot use the positional operator inside another Array");if("array"==t){i||(i=e);var n=a.slice(l);for(var v in r){var s=o(r[v],e[v],n);void 0!==s&&(e[v]=s)}return i}if("object"!=t)return i;if(!Object.hasOwnProperty.call(r,f))return i;i||(i=e),r=r[f],t=getTypeStr(r),e=Object.hasOwnProperty.call(e,f)?e[f]:e[f]="object"==t?{}:[]}var y=a[a.length-1];if(i||(i=e),"array"==t){for(var v in r){var s=o(r[v],e[v],[y]);void 0!==s&&(e[v]=s)}return i}return"object"!=t?i:(Object.hasOwnProperty.call(r,y)&&(e[y]=r[y],i||(i=e)),i)}a||(a=e,e=void 0);var i,t,n,l={};for(var s in a){for(var c=a[s],f=r,v=l,y=s.split("."),p=!1,u="object",h=0,w=y.length-1;h<w;h++){if(void 0===f){p=!0;break}if(i&&y.slice(0,h+1).join(".")==i){p=!0;break}var b=y[h];if("$"==b){if("array"!=u)throw new Error("positional operator requires an Array");if(!e)throw new Error("positional operator requires an query");if(i)throw new Error("cannot use the positional operator on more than one Array");var j=y.slice(0,h);i=j.join(".");var $=resolveDollar(r,e,j,i);if($<0){p=!0;break}n[t]=[f[$]],p=!0;break}if("array"==u){var d=y.slice(h);for(var h in f){var O=o(f[h],v[h],d);void 0!==O&&(v[h]=O)}p=!0;break}if(n=v,t=b,f=f[b],u=getTypeStr(f),Object.hasOwnProperty.call(v,b))v=v[b];else if("object"==u)v=v[b]={};else{if("array"!=u){p=!0;break}v=v[b]=[]}}if(!p){var q=y[y.length-1];if("$"!=q)if("array"!=u){if(f=f[q],Object.hasOwnProperty.call(c,"$elemMatch")||Object.hasOwnProperty.call(c,"$slice")){if(f instanceof Array)if(c.$elemMatch){v=v[q]=[];for(var g in f)if(matchQuery(f[g],c.$elemMatch)){v.push(f[g]);break}}else{if(!c.$slice)throw new Error("unsupported query option "+JSON.stringify(c));if(c.$slice instanceof Number)c.$slice>=0?v[q]=f.slice(0,c.$slice):v[q]=f.slice(c.$slice);else if(!(c.$slice instanceof Array))throw new Error("$slice requires an Array of boundary indices");v[q]=f.slice(c.$slice[0],c.$slice[0]+c.$slice[1])}}else if(void 0!==f){var m=getTypeStr(f);if("array"!=m)v[q]=f;else{var E=v[q]=[];E.push.apply(E,f)}}}else for(var h in f){var O=o(f[h],v[h],[q]);void 0!==O&&(v[h]=O)}else{if("array"!=u)throw new Error("positional operator requires an Array");if(!e)throw new Error("positional operator requires an query");if(i)throw new Error("cannot use the positional operator on more than one Array");var j=y.slice(0,h);i=j.join(".");var $=resolveDollar(r,e,j,i);if($<0)continue;n[t]=[f[$]]}}}return l}var getTypeStr=require("./GetTypeStr"),resolveDollar=require("./ResolveDollar"),matchQuery=require("./MatchQuery");module.exports=project;
},{"./GetTypeStr":15,"./MatchQuery":17,"./ResolveDollar":22}],21:[function(require,module,exports){
var getTypeStr=require("./GetTypeStr"),matchLeaves=require("./MatchLeaves"),matchQuery=require("./MatchQuery"),LOOKUP_BSON_TYPE={1:"number",2:"string",3:"object",4:"array",5:"buffer",6:"undefined",8:"boolean",9:"date",10:"null",11:"regexp",13:"function",16:"number",18:"number"},fieldOps={$not:function(r,e){if("object"!=getTypeStr(r))throw new Error("$not requires a query document");return!matchQuery(r,e)},$gt:function(r,e){return!("number"!=typeof r||"number"!=typeof e||r<=e)},$gte:function(r,e){return!("number"!=typeof r||"number"!=typeof e||r<e)},$in:function(r,e){if("array"!=getTypeStr(e))throw new Error("$in requires an Array");var t="string"==typeof r;for(var n in e){var u=e[n];if("regexp"==getTypeStr(u)){if(!t)continue;if(r.match(u))return!0}else if(matchLeaves(u,r))return!0}return!1},$lt:function(r,e){return!("number"!=typeof r||"number"!=typeof e||r>=e)},$lte:function(r,e){return!("number"!=typeof r||"number"!=typeof e||r>e)},$ne:function(r,e){return!matchLeaves(r,e)},$nin:function(r,e){if("array"!=getTypeStr(e))throw new Error("$nin requires an Array");var t="string"==typeof r;for(var n in e){var u=e[n];if("regexp"==getTypeStr(u)){if(!t)continue;if(r.match(u))return!1}else if(matchLeaves(e[n],r))return!1}return!0},$mod:function(r,e){if("array"!=getTypeStr(e)||2!=e.length)throw new Error("$in requires an Array of [ divisor, remainder ]");return"number"==typeof r&&r%e[0]==e[1]},$regex:function(r,e){if("regexp"!=getTypeStr(e))throw new Error("$regex requires a RegExp");return"string"==typeof r&&!!r.match(e)},$type:function(r,e){if("number"!=getTypeStr(e))throw new Error("$type requires a BSON type integer");return!!LOOKUP_BSON_TYPE.hasOwnProperty(e)&&getTypeStr(r)==LOOKUP_BSON_TYPE[e]}},arrOps={$all:function(r,e){if("array"!=getTypeStr(e))throw new Error("$all requires an Array of values");if(!r.length)return!0;var t=[];t.push.apply(t,e);for(var n in r)for(var u=0,o=t.length;u<o;u++)if(matchLeaves(r[n],t[u])&&(t.splice(u,1),u--,!--o))return!0;return!1},$elemMatch:function(r,e){if("object"!=getTypeStr(e))throw new Error("$elemMatch requires a query document");for(var t in r)if(matchQuery(r[t],e))return!0;return!1},$size:function(r,e){if("number"!=getTypeStr(e))throw new Error("$size requires an integer");return r.length==e}},ops={};for(var key in fieldOps)ops[key]=fieldOps[key];for(var key in arrOps)ops[key]=arrOps[key];module.exports.ops=ops,module.exports.fieldOps=fieldOps,module.exports.arrOps=arrOps;
},{"./GetTypeStr":15,"./MatchLeaves":16,"./MatchQuery":17}],22:[function(require,module,exports){
function resolveDollar(r,e,a,t){var l=r;for(var c in a)l=l[a[c]];if(!l.length)return-1;var i=t.length,n=-1,f=!1;for(var o in e)if(o.slice(0,i)==t){var v=e[o];if(v instanceof Object&&Object.hasOwnProperty.call(v,"$elemMatch")){for(var c in l)if(matchQuery(l[c],v.$elemMatch)){n=c;break}if(n>=0)return n}else if(!f){var h={};h[o.slice(i+1)]=v;for(var c in l)if(matchQuery(l[c],h)){try{var u=Object.keys(v);u.length&&"$"==u[0][0]&&(f=!0)}catch(r){}n=c;break}}}return n}var matchQuery=require("./MatchQuery");module.exports=resolveDollar;
},{"./MatchQuery":17}],23:[function(require,module,exports){
function Set(t){if(this.strings={},this.nums={},this.others=[],t)for(var r in t){var e=t[r],s=getTypeStr(e);if("string"==s)this.strings[e]=!0;else if("number"==s)this.nums[e]=!0;else{var i=!1;for(var n in this.others)if(matchLeaves(e,this.others[n])){i=!0;break}i||this.others.push(e)}}}var matchLeaves=require("./MatchQuery").matchLeaves,getTypeStr=require("./GetTypeStr");Set.prototype.union=function(t){for(var r in t.strings)this.strings[r]=!0;for(var r in t.nums)this.nums[r]=!0;for(var e in t.others){var s=!1;for(var i in this.others)if(matchLeaves(t.others[e],this.others[i])){s=!0;break}s||this.others.push(t.others[e])}},Set.prototype.difference=function(t){for(var r in t.strings)delete this.strings[r];for(var r in t.nums)delete this.nums[r];for(var e in t.others)for(var s=0,i=this.others.length;s<i;s++)if(matchLeaves(this.others[s],t.others[e])){this.others.splice(s,1),s--,i--;break}},Set.prototype.intersect=function(t){var r=new Set([]);for(var e in t.strings)Object.hasOwnProperty.call(this.strings,e)&&(r.strings[e]=!0);for(var e in t.nums)Object.hasOwnProperty.call(this.nums,e)&&(r.nums[e]=!0);for(var s in t.others)for(var i=0,n=this.others.length;i<n;i++)if(matchLeaves(this.others[i],t.others[s])){r.others.push(this.others[i]);break}return r},Set.prototype.equals=function(t){if(this.others.length!=t.others.length)return!1;var r=Object.keys(this.strings),e=Object.keys(this.nums),s=Object.keys(t.strings),i=Object.keys(t.nums);if(r.length!=s.length||e.length!=i.length)return!1;for(var n in r)if(!Object.hasOwnProperty.call(t.strings,r[n]))return!1;for(var n in e)if(!Object.hasOwnProperty.call(t.nums,e[n]))return!1;for(var n in this.others){var h=!1;for(var o in t.others)if(matchLeaves(t.others[o],this.others[n])){h=!0;break}if(!h)return!1}return!0},Set.prototype.contains=function(t){for(var r in t.strings)if(!Object.hasOwnProperty.call(this.strings,r))return!1;for(var r in t.nums)if(!Object.hasOwnProperty.call(this.nums,r))return!1;for(var e in t.others){var s=!1;for(var i in this.others)if(matchLeaves(this.others[i],t.others[e])){s=!0;break}if(!s)return!1}return!0},Set.prototype.add=function(t){var r=getTypeStr(t);if("string"!=r||Object.hasOwnProperty.call(this.nums,t))if("number"!=r||Object.hasOwnProperty.call(this.nums,String(t))){var e=!1;for(var s in this.others)if(matchLeaves(t,this.others[s])){e=!0;break}if(!e)return this.others.push(t),!0}else this.nums[t]=!0;else this.strings[t]=!0},Set.prototype.export=function(){var t=Object.keys(this.strings);return t.push.apply(t,Object.keys(this.nums).map(Number)),t.push.apply(t,this.others),t},module.exports=Set;
},{"./GetTypeStr":15,"./MatchQuery":17}],24:[function(require,module,exports){
function getLeafsort(r){function e(t,n){if(t===n)return 0;var a=getTypeStr(t),f=getTypeStr(n);if(a!=f)return Math.max(-1,Math.min(1,r*(SORT_PRIORITY[f]-SORT_PRIORITY[a])));if("number"==a)return Math.max(-1,Math.min(1,r*(n-t)));if("string"==a)return n>t?r:-1*r;if("object"==a){var i=Object.keys(t)[0],o=Object.keys(n)[0];for(var u in o){if(i[u]!=o[u])return o[u]>i[u]?r:-1*r;var l=e(t[i[u]],n[i[u]]);if(l)return l}}if("array"==a){if(!a.length)return f.length?1:0;if(!f.length)return a.length?-1:0;if(r>0){for(var h=t[0],R=n[0],u=1,g=t.length;u<g;u++)r*e(h,t[u])>0&&(h=t[u]);for(var u=1,g=n.length;u<g;u++)r*e(R,t[u])>0&&(R=n[u]);return e(h,R)}for(var O=t[0],s=n[0],u=1,g=t.length;u<g;u++)r*e(O,t[u])<0&&(O=t[u]);for(var u=1,g=n.length;u<g;u++)r*e(s,t[u])<0&&(s=n[u]);return e(O,s)}if("buffer"==a){if(t.length!=n.length)return Math.max(-1,Math.min(1,r*(n.length-t.length)));for(var u=0,g=t.length;u<g;u++)if(t[u]!=n[u])return Math.max(-1,Math.min(1,r*(Number(n[u])-Number(t[u]))));return 0}return"boolean"==a?f?r:-1*r:"date"==a?n>t?r:-1*r:0}return r*=-1,e}function getDocsort(r){var e=getLeafsort(1),t=[],n=Object.keys(r);for(var a in r){if(a.match(/\$/))throw new Error("invalid sort path "+a);t.push(a.split("."))}return function(a,f){for(var i in t){var o=t[i],u=a,l=f,h=r[n[i]]>0?1:-1;for(var R in o){var g=o[R];if(Object.hasOwnProperty.call(a,g)){if(Object.hasOwnProperty.call(f,g))u=u[g],l=l[g];else if(Object.hasOwnProperty.call(a,g))return-1*h}else if(Object.hasOwnProperty.call(f,g))return h}var O=h*e(u,l);if(O)return O}return 0}}var getTypeStr=require("./GetTypeStr"),ARR_SORT_PRIORITY=["null","number","string","object","array","buffer","boolean","date","regexp"],SORT_PRIORITY={};for(var i in ARR_SORT_PRIORITY)SORT_PRIORITY[ARR_SORT_PRIORITY[i]]=i;module.exports.getLeafsort=getLeafsort,module.exports.getDocsort=getDocsort;
},{"./GetTypeStr":15}],25:[function(require,module,exports){
function update(r,e,a){if(a||(a=e,e=r,r=void 0),Object.hasOwnProperty.call(a,"$rename"))for(var o in a.$rename){var t,n=e,i=o.split(".");for(var l in i){var s=getTypeStr(n);if("object"!=s&&"array"!=s)throw new Error("cannot traverse data to rename path "+o);var h=i[l];if("$"==h[0])throw new Error("cannot rename dynamic path "+o);if(!Object.hasOwnProperty.call(n,h)){t=!0;break}n=n[h]}if(!t){var p=a.$rename[o];if(Object.hasOwnProperty.call(a,"$set")||(a.$set={}),Object.hasOwnProperty.call(a.$set,p))throw new Error("cannot rename more than one value to the same path "+p);a.$set[p]=n,Object.hasOwnProperty.call(a,"$unset")||(a.$unset={}),a.$unset[o]=!0}}var f,w;for(var c in a){var $=a[c];if(!operators.ops.hasOwnProperty(c))throw new Error("unrecognized operator "+c);if("$rename"!=c&&"$isolated"!=c){var v=STUBBORN_OPS.hasOwnProperty(c);for(var d in $){for(var y=!1,i=d.split("."),n=e,u="object",O=!0,l=0,b=i.length-1;l<b;l++){if("object"!=u&&"array"!=u)throw new Error("Encountered a leaf in the middle of the path "+d);var h=i[l];if("$"!=h){if("$"==h[0])throw new Error("invalid path "+d);if(y)n=n[h]={};else if(Object.hasOwnProperty.call(n,h))n=n[h],u=getTypeStr(n);else{if(!v){O=!1;break}y=!0,n=n[h]={},u="object"}}else{if(y){O=!1;break}if("array"!=u)throw new Error("Found a non-Array ("+u+") at the $ operator in path "+d);if(!l)throw new Error("The path "+d+" is invalid because it begins with the $ operator.");var m=i.slice(0,l),E=m.join(".");if(void 0!==f&&E!=w)throw new Error("The $ operator may only be used on one field (at "+d+")");if(f=m,w=E,(h=resolveDollar(e,r,f,w))<0)continue;n=n[h],u="array"}}if(O){if("object"!=u&&"array"!=u)throw new Error("Encountered a leaf in the middle of the path "+d);var h=i[i.length-1];if("$"==h){if(y)continue;if("array"!=u)throw new Error("Found a non-Array ("+u+") at the $ operator in path "+d);var m=i.slice(0,l),E=m.join(".");if(void 0!==f&&E!=w)throw new Error("The $ operator may only be used on one field (at "+d+")");if(f=m,w=E,(h=resolveDollar(e,r,f,w))<0)continue}else if("$"==h[0])throw new Error("invalid path "+d);if(operators.arrOps.hasOwnProperty(c))if(void 0===n[h]){if(!v)continue;n[h]=[]}else if("array"!=getTypeStr(n[h]))throw new Error("cannot apply "+c+" to non-array value");operators.ops[c](n,h,$[d])}}}}}var MOD_OPS={$each:!0,$position:!0,$slice:!0,$sort:!0},STUBBORN_OPS={$set:!0,$inc:!0,$min:!0,$max:!0,$mul:!0,$currentDate:!0,$addToSet:!0,$push:!0,$pushAll:!0};module.exports=update;var operators=require("./UpdateOperators"),getTypeStr=require("./GetTypeStr"),resolveDollar=require("./ResolveDollar");update.resolveDollar=resolveDollar;
},{"./GetTypeStr":15,"./ResolveDollar":22,"./UpdateOperators":26}],26:[function(require,module,exports){
var getTypeStr=require("./GetTypeStr"),Sorting=require("./Sorting"),moreDollars=require("./MoreDollars"),matchLeaves=require("./MatchLeaves"),matchQuery=require("./MatchQuery"),fieldOps={$set:function(r,e,o){var t=getTypeStr(o);if("object"==t&&moreDollars(o)||"array"==t&&moreDollars(o,!0))throw new Error("invalid property key in complex update");r[e]=o},$inc:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("cannot $inc by a non-numeric value");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $inc on a non-numeric value");r[e]+=o}else r[e]=o},$min:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("cannot $min to a non-numeric value");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $min on a non-numeric value");r[e]=Math.min(r[e],o)}else r[e]=o},$max:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("cannot $max to a non-numeric value");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $max on a non-numeric value");r[e]=Math.max(r[e],o)}else r[e]=o},$mul:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("cannot $mul by a non-numeric value");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $mul on a non-numeric value");r[e]*=o}else r[e]=0},$bit:function(r,e,o){if("object"!=getTypeStr(o))throw new Error("invalid $bit update");if(Object.hasOwnProperty.call(r,e)){if("number"!=getTypeStr(r[e]))throw new Error("cannot apply $bit on a non-numeric value")}else r[e]=0;for(var t in o){var n=o[t];if("number"!=typeof n)throw new Error("cannot $bit by a non-numeric value");if("and"==t)r[e]&=n;else if("or"==t)r[e]|=n;else{if("xor"!=t)throw new Error("unknown bit operation "+t);r[e]^=n}}},$unset:function(r,e,o){delete r[e]},$currentDate:function(r,e,o){r[e]=new Date},$rename:!0,$isolated:!0},arrOps={$addToSet:function(r,e,o){if(Object.hasOwnProperty.call(o,"$position")||Object.hasOwnProperty.call(o,"$sort")||Object.hasOwnProperty.call(o,"$slice"))throw new Error("Ordering modifiers are not allowed together with $addToSet");if(!Object.hasOwnProperty.call(r,e))return void(r[e]=[o]);var t=r[e];if("object"==getTypeStr(o)&&Object.hasOwnProperty.call(o,"$each"))for(var n in o.$each){var a=o.$each[n],i=!0;for(var l in t)if(matchLeaves(t[l],a)){i=!1;break}i&&t.push(o.$each[n])}else{for(var n in t)if(matchLeaves(t[n],o))return;t.push(o)}},$push:function(r,e,o){var t=getTypeStr(o),n=r[e];if("object"!=t)n.push(o);else if(Object.hasOwnProperty.call(o,"$each")){var a,i=o.$each;if(Object.hasOwnProperty.call(o,"$position")){if(o.$position<0)throw new Error("$position does not accept negative numbers");a=o.$position>=n.length?void 0:o.$position}if(void 0===a)for(var l in i){if(moreDollars(i[l]))throw new Error("invalid property key in complex update");n.push(i[l])}else for(var l in i){if(moreDollars(i[l]))throw new Error("invalid property key in complex update");n.splice(a,0,i[l])}if(Object.hasOwnProperty.call(o,"$sort")){var p=o.$sort;"number"==typeof p?(p=p>0?1:-1,n.sort(Sorting.getLeafsort(p))):n.sort(Sorting.getDocsort(p))}Object.hasOwnProperty.call(o,"$slice")&&(o.$slice<0?r[e]=n.slice(o.$slice):r[e]=n.slice(0,o.$slice))}else moreDollars(o)||n.push(o)},$pop:function(r,e,o){if("number"!=getTypeStr(o))throw new Error("$pop requires a number");o>0?arr.pop():o<0&&arr.shift()},$pull:function(r,e,o){var t=r[e];if("object"==getTypeStr(o))for(var n=0,a=t.length;n<a;n++)matchQuery(t[n],o)&&(t.splice(n,1),n--,a--);else for(var n=0,a=t.length;n<a;n++)matchLeaves(t[n],o)&&(t.splice(n,1),n--,a--)},$pullAll:function(r,e,o){var t=r[e];if("array"!=getTypeStr(o))throw new Error("$pullAll requires an Array of values/documents to match");for(var n in o)for(var a=0,i=t.length;a<i;a++)matchLeaves(t[a],o[n])&&(t.splice(a,1),a--,i--)}},ops={};for(var op in fieldOps)ops[op]=fieldOps[op];for(var op in arrOps)ops[op]=arrOps[op];module.exports.ops=ops,module.exports.fieldOps=fieldOps,module.exports.arrOps=arrOps;
},{"./GetTypeStr":15,"./MatchLeaves":16,"./MatchQuery":17,"./MoreDollars":19,"./Sorting":24}],27:[function(require,module,exports){
exports.read=function(a,o,t,r,h){var M,p,w=8*h-r-1,f=(1<<w)-1,e=f>>1,i=-7,N=t?h-1:0,n=t?-1:1,s=a[o+N];for(N+=n,M=s&(1<<-i)-1,s>>=-i,i+=w;i>0;M=256*M+a[o+N],N+=n,i-=8);for(p=M&(1<<-i)-1,M>>=-i,i+=r;i>0;p=256*p+a[o+N],N+=n,i-=8);if(0===M)M=1-e;else{if(M===f)return p?NaN:1/0*(s?-1:1);p+=Math.pow(2,r),M-=e}return(s?-1:1)*p*Math.pow(2,M-r)},exports.write=function(a,o,t,r,h,M){var p,w,f,e=8*M-h-1,i=(1<<e)-1,N=i>>1,n=23===h?Math.pow(2,-24)-Math.pow(2,-77):0,s=r?0:M-1,u=r?1:-1,l=o<0||0===o&&1/o<0?1:0;for(o=Math.abs(o),isNaN(o)||o===1/0?(w=isNaN(o)?1:0,p=i):(p=Math.floor(Math.log(o)/Math.LN2),o*(f=Math.pow(2,-p))<1&&(p--,f*=2),o+=p+N>=1?n/f:n*Math.pow(2,1-N),o*f>=2&&(p++,f/=2),p+N>=i?(w=0,p=i):p+N>=1?(w=(o*f-1)*Math.pow(2,h),p+=N):(w=o*Math.pow(2,N-1)*Math.pow(2,h),p=0));h>=8;a[t+s]=255&w,s+=u,w/=256,h-=8);for(p=p<<h|w,e+=h;e>0;a[t+s]=255&p,s+=u,p/=256,e-=8);a[t+s-u]|=128*l};
},{}],28:[function(require,module,exports){
function IndexedLinkedList(){this.list={},this.length=0,this.head=null,this.tail=null}IndexedLinkedList.prototype.dequeue=function(){return this._removeItem(this.head)},IndexedLinkedList.prototype.remove=function(t){this._removeItem(this.list[t])},IndexedLinkedList.prototype.push=function(t,e){var i=this._resetIndex(t,e);null!=this.head&&(this.head.prev=i),i.prev=null,i.next=this.head,this.head=i,0==this.length&&(this.tail=i),this.length++},IndexedLinkedList.prototype.enqueue=function(t,e){var i=this._resetIndex(t,e);null!=this.tail&&(this.tail.next=i),i.next=null,i.prev=this.tail,this.tail=i,0==this.length&&(this.head=i),this.length++},IndexedLinkedList.prototype._resetIndex=function(t,e){try{this.remove(t)}catch(t){}return this._set(t,e)},IndexedLinkedList.prototype._set=function(t,e){return"object"==typeof this.list[t]?this.list[t].data=e:this.list[t]={data:e,next:void 0,prev:void 0},this.list[t]},IndexedLinkedList.prototype._removeItem=function(t){if("object"!=typeof t||null==t)throw new Error("undefined_item");return null==t.next?this.tail=t.prev:t.next.prev=t.prev,null==t.prev?this.head=t.next:t.prev.next=t.next,this.length--,t.data},module.exports=function(){return new IndexedLinkedList};
},{}],29:[function(require,module,exports){
function MongoLocal(e){void 0!==e&&null!==e||(e={}),this.config=e,this.collection="object"==typeof this.config.collection||Array.isArray(this.config.collection)?this.config.collection:{},this.docsLinkedList=IndexedLinkedList()}var FauxMongo=require("fauxmongo"),ObjectId=require("objectid"),EventEmitter=require("wolfy87-eventemitter"),Utils=require("./Utils"),MongoLocalCursor=require("./MongoLocalCursor"),IndexedLinkedList=require("./IndexedLinkedList");MongoLocal.prototype.__proto__=EventEmitter.prototype,MongoLocal.prototype.find=function(){function e(){if(Array.isArray(l.collection)){for(n>0&&r!=l.collection[n]&&n--;!c&&n<l.collection.length;){var e={index:n,doc:l.collection[n]};if(l._docFilter(e.doc,u))return r=e.doc,e;n++}return null}if(1!=Object.keys(u).length||"string"!=typeof u._id&&"number"!=typeof u._id){for(;null!=i;){var e={index:i.data,doc:l.collection[i.data]};if(l._docFilter(e.doc,u))return e;i=i.next}return null}return void 0===l.collection[u._id]||c?null:{index:u._id,doc:l.collection[u._id]}}function t(){var t=e();return 1==Object.keys(u).length&&void 0!==u._id&&(c=!0),Array.isArray(l.collection)?(n++,r=l.collection[n]):null!=i&&(i=i.next),t}function o(){c=!1,Array.isArray(l.collection)?n=0:i=l.docsLinkedList.head}var n,i,c,r,l=this,a=Utils.parseArgs(arguments,[{name:"query",level:1,validate:function(e,t){return"object"==typeof e||"string"==typeof e},default:{}},{name:"projection",level:1,validate:function(e,t){return"object"==typeof e}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),u=l._validateQuery(a.query);o();var f=MongoLocalCursor(e,t,o);return"function"==typeof a.callback&&a.callback(null,f),f},MongoLocal.prototype.findOne=function(){var e=Utils.parseArgs(arguments,[{name:"query",level:1,validate:function(e,t){return"object"==typeof e||"string"==typeof e},default:{}},{name:"projection",level:1,validate:function(e,t){return"object"==typeof e}},{name:"callback",level:0,validate:function(e,t){return"function"==typeof e}}]);this.find(e.query,e.projection).next(function(t,o){e.callback(t,o)})},MongoLocal.prototype.insert=function(){function e(e,t){"function"==typeof i.callback&&i.callback(e,t)}function t(e,t){void 0===e._id?(e._id=n._objectId(),o(e,t)):n.findOne({_id:e._id},function(n,i){n?t("find_error"):null!=i?t("id_exists"):o(e,t)})}function o(e,t){"function"==typeof n.config.insert?n.config.insert(e):Array.isArray(n.collection)?n.collection.push(e):n.collection[e._id]=e,n._cappedInsert(e._id,c.emitCascade),c.emit&&n.emit("insert",e,c),t(null)}var n=this,i=Utils.parseArgs(arguments,[{name:"docs",level:0,validate:function(e,t){return"object"==typeof e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),c=Utils.objectMerge({emit:!0},i.options);if(c=Utils.objectMerge({emitCascade:c.emit},c),Array.isArray(i.docs)){var r=!0;i.docs.forEach(function(o){t(o,function(t){t&&(r=!1,e(t))})}),r&&e(null,null)}else t(i.docs,function(t){t?e(t,null):e(null,null)})},MongoLocal.prototype._cloneObject=function(e){return JSON.parse(JSON.stringify(e))},MongoLocal.prototype.update=function(){var e=Utils.parseArgs(arguments,[{name:"query",level:1,validate:function(e,t){return"object"==typeof e||"string"==typeof e},default:{}},{name:"updateOperations",level:0,validate:function(e,t){return"object"==typeof e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),t=this,o=Utils.objectMerge({emit:!0,multi:!1,upsert:!1},e.options);o=Utils.objectMerge({emitCascade:o.emit},o);var n=t._validateQuery(e.query),i=this._validateUpdate(e.updateOperations);if(!o.multi)var c={};try{var r=0;if(this.find(e.query)._forEachDocIndex(function(e,n){if(r++,o.emit)var l=t._cloneObject(e);if("function"==typeof t.config.update){var a=t._updateDoc(e,i,!0);t.config.update(n,l,a)}else var a=t._updateDoc(e,i,!1);if(o.emit&&t.emit("update",l,a,i,o),!o.multi)throw c}),!r&&o.upsert){var l={};void 0!==n._id&&(l._id=n._id),FauxMongo.update(l,i);var a=t._cloneObject(o);a.emit=a.emitCascade,t.insert(l,a,e.callback)}}catch(e){if(e!==c)throw e}"function"!=typeof e.callback||!r&&o.upsert||e.callback(null,!0)},MongoLocal.prototype.remove=function(){var e=Utils.parseArgs(arguments,[{name:"query",level:1,validate:function(e,t){return"object"==typeof e||"string"==typeof e},default:{}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),t=Utils.objectMerge({emit:!0,justOne:!1},e.options);t=Utils.objectMerge({emitCascade:t.emit},t);var o=this,n=o._validateQuery(e.query);o.find(n)._forEachDocIndex(function(e,n){if(t.emit)var i=o._cloneObject(e);var c=e._id;"function"==typeof o.config.remove?o.config.remove(n):Array.isArray(o.collection)?o.collection.splice(n,1):delete o.collection[n],o._cappedRemove(c),t.emit&&o.emit("remove",i,t)}),"function"==typeof e.callback&&e.callback(null,!0)},MongoLocal.prototype.isCapped=function(){return"number"==typeof this.config.max},MongoLocal.prototype._validateUpdate=function(e){var t={};return Utils.objectForEach(e,function(e,o){"$set"==o?t.$set=Utils.objectMerge(t.$set,e):"$"==o.charAt(0)?t[o]=e:("object"==typeof t.$set&&null!=t.$set||(t.$set={}),t.$set[o]=e)}),t},MongoLocal.prototype._validateQuery=function(e){return"object"!=typeof e?{_id:e}:e},MongoLocal.prototype._updateDoc=function(e,t,o){"boolean"==typeof o&&o&&(e=this._cloneObject(e));var n={};return Utils.objectForEach(t,function(t,o){"$"==o.charAt(0)?n[o]=t:e[o]=t}),FauxMongo.update(e,n),e},MongoLocal.prototype._docFilter=function(e,t){return FauxMongo.matchQuery(e,t)},MongoLocal.prototype._cappedInsert=function(e,t){if("boolean"!=typeof t&&(t=!0),!this.isCapped()&&Array.isArray(this.collection)||this.docsLinkedList.enqueue(e,e),this.isCapped())for(;this.docsLinkedList.length>this.config.max;){var o=this.docsLinkedList.head.data;this.remove(o,{emit:t})}},MongoLocal.prototype._cappedRemove=function(e){try{this.docsLinkedList.remove(e)}catch(e){if("undefined_item"!=e.message)throw e}},MongoLocal.prototype._objectId=function(){return"function"==typeof this.config.objectId?this.config.objectId():ObjectId()},module.exports=function(e){return new MongoLocal(e)};
},{"./IndexedLinkedList":28,"./MongoLocalCursor":30,"./Utils":31,"fauxmongo":9,"objectid":41,"wolfy87-eventemitter":58}],30:[function(require,module,exports){
function MongoLocalCursor(o,n,t){this._peekResult=o,this._nextResult=n,this._rewindResults=t}MongoLocalCursor.prototype.next=function(o){this._nextDocIndex(function(n,t,u){o(n,t)})},MongoLocalCursor.prototype.hasNext=function(o){o(null,null!=this._peekResult())},MongoLocalCursor.prototype.rewind=function(o){this._rewindResults()},MongoLocalCursor.prototype.forEach=function(o){this._forEachDocIndex(function(n){o(n)})},MongoLocalCursor.prototype.toArray=function(o){function n(){t.next(function(t,r){t?o(t,null):null==r?o(t,u):(u.push(r),n())})}var t=this,u=[];n()},MongoLocalCursor.prototype._forEachDocIndex=function(o){function n(){t._nextDocIndex(function(t,u,r){t||null===r||(o(u,r),n())})}var t=this;n()},MongoLocalCursor.prototype._nextDocIndex=function(o){var n=this._nextResult();null==n?o(null,null,null):o(null,n.doc,n.index)},module.exports=function(o,n,t){return new MongoLocalCursor(o,n,t)};
},{}],31:[function(require,module,exports){
var Utils={};Utils.objectFilterProperties=function(e,t){var n={};return t.forEach(function(t){n[t]=e[t]}),n},Utils.objectContainsObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)&&(!e.hasOwnProperty(n)||e[n]!=t[n]))return!1;return!0},Utils.objectFilter=function(e,t){var n={};return this.objectForEach(e,function(e,r,i){t(e,r,i)&&(n[r]=e)}),n},Utils.objectForEach=function(e,t){var n;for(n in e)e.hasOwnProperty(n)&&t(e[n],n,e)},Utils.objectGet=function(e,t){var n=this;if(0==t.length)return e;if("object"==typeof e){if(("string"==typeof t[0]||"number"==typeof t[0])&&null!==e&&e.hasOwnProperty(t[0]))return this.objectGet(e[t[0]],t.slice(1));if(null===t[0]){if(Array.isArray(e)){var r=[];e.forEach(function(e,i){r[i]=n.objectGet(e,t.slice(1))})}else{var r={};this.objectForEach(e,function(e,i){r[i]=n.objectGet(e,t.slice(1))})}return r}if(t[0]instanceof RegExp){var r={};return this.objectForEach(e,function(e,i){i.match(t[0])&&(r[i]=n.objectGet(e,t.slice(1)))}),r}if("function"==typeof t[0]){if(e instanceof Array){var r=[];e.forEach(function(e,i,o){t[0](e,i,o)&&(r[i]=n.objectGet(e,t.slice(1)))})}else{var r={};this.objectForEach(n.objectFilter(e,t[0]),function(e,i){r[i]=n.objectGet(e,t.slice(1))})}return r}if(t[0]instanceof Array){if(e instanceof Array){var r=[];t[0].forEach(function(t,n){r[n]=e[n]})}else{var r={};this.objectForEach(n.objectFilterProperties(e,t[0]),function(e,i){r[i]=n.objectGet(e,t.slice(1))})}return r}}},Utils.objectSet=function(e,t,n){return 1==t.length?(e[t[0]]=n,!0):(void 0===e[t[0]]&&(e[t[0]]={}),this._objectSet(e[t[0]],t.slice(1),n))},Utils.objectIsset=function(e,t){return 1==t.length?void 0!==e[t[0]]:void 0!==e[t[0]]&&this.objectIsset(e[t[0]],t.slice(1))},Utils.objectMerge=function(){var e={};return this.objectForEach(arguments,function(t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}),e},Utils.uniqueId=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},Utils.parseArgs=function(e,t){function n(e,t){return"function"!=typeof e.validate||e.validate(t)}function r(e,t){for(var n=t;n<e.length;n++)if(void 0===e[n]||!e[n].required)return!0;return!1}var i={},o=0;return Array.isArray(e)||(e=Array.prototype.slice.call(e)),e.forEach(function(e,c){for(var a=o;a<t.length;a++){if(t[a].required){if(n(t[a],e)){t[a].matched=!0,i[t[a].name]=e,o++;break}throw"missing_required"}if(!t[a].required&&(r(t,a)||t[a].level>t[a-1].level&&t[a-1].matched)&&n(t[a],e)){t[a].matched=!0,i[t[a].name]=e,o++;break}t[a].matched=!1,o++}}),t.forEach(function(e){void 0===i[e.name]&&void 0!==e.default&&(i[e.name]=e.default)}),i},Utils.callbackQueue=function(){function e(){r||(r=!0,n.queueCompleteCallback.apply(this,Array.prototype.slice.call(arguments)))}function t(){i++,"function"==typeof n.queueFunctions[i]?Array.isArray(n.queueFunctionArgs)&&!n.options.expand?n.queueFunctions[i](n.queueFunctionArgs,t,e):Array.isArray(n.queueFunctionArgs)&&n.options.expand?n.queueFunctions[i].apply(this,n.queueFunctionArgs.concat([t,e])):n.queueFunctions[i](t,e):"function"!=typeof n.queueNoMatchCallback||r||n.queueNoMatchCallback()}var n=Utils.parseArgs(arguments,[{name:"queueFunctions",level:0,validate:function(e,t){return Array.isArray(e)}},{name:"queueFunctionArgs",level:1,validate:function(e,t){return Array.isArray(e)}},{name:"queueCompleteCallback",level:0,validate:function(e,t){return"function"==typeof e}},{name:"queueNoMatchCallback",level:1,validate:function(e,t){return"function"==typeof e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}}]);n.options=Utils.objectMerge({expand:!1},n.options);var r=!1,i=-1;t()},module.exports=Utils;
},{}],32:[function(require,module,exports){
function Router(){this.useRoutes=[],this.methodRoutes={},this.index=0}var UrlPattern=require("url-pattern");Router.prototype.route=function(){function t(){var r=n.shift();void 0!==r?(e.params=r.params,"function"==typeof r.handler?r.handler(e,o,t):Router._isRouter(r.handler)?r.handler.route(e.method,"/"+e.params._,e,o,t):t()):"function"==typeof a&&a()}if(3==arguments.length)var e={},o=arguments[2];else if(arguments.length>=4){var e=arguments[2];"object"==typeof e&&e||(e={});var o=arguments[3]}e.method=arguments[0];var r=arguments[1];void 0===e.path&&(e.path=r);var a=arguments[4],n=this._methodPathMatches(e.method,r);t()},Router.prototype.use=function(){var t="string"==typeof arguments[0]?arguments[0]:"",e=Router._validHandler(arguments[0])?arguments[0]:arguments[1];return this._addRouteToArray(this.useRoutes,Router._normalizePath(t),e)},Router.prototype.useFirst=function(){var t="string"==typeof arguments[0]?arguments[0]:"",e=Router._validHandler(arguments[0])?arguments[0]:arguments[1];return this._addRouteToArray(this.useRoutes,Router._normalizePath(t),e,!0)},Router.prototype.method=function(t,e,o){return this.methodRoutes[t]instanceof Array||(this.methodRoutes[t]=[]),this._addRouteToArray(this.methodRoutes[t],Router._normalizePath(e),o)},Router._validHandler=function(t){return"function"==typeof t||Router._isRouter(t)},Router._isRouter=function(t){return"object"==typeof t&&"function"==typeof t.route},Router._normalizePath=function(t){return t.replace(/\/$/,"")},Router.prototype._methodPathMatches=function(t,e){var o=Router._normalizePath(e),r=[],a=this;return a.useRoutes.forEach(function(t){var e=new UrlPattern(t.path+"(/*)").match(o);null!==e&&r.push({path:t.path,handler:t.handler,params:e})}),a.methodRoutes[t]instanceof Array&&a.methodRoutes[t].forEach(function(t){var e=new UrlPattern(t.path).match(o);null!==e&&r.push({path:t.path,handler:t.handler,params:e})}),r},Router.prototype._addRouteToArray=function(t,e,o,r){var a={path:e,handler:o};"boolean"==typeof r?t.unshift(a):t.push(a)},module.exports=function(){return new Router};
},{"url-pattern":33}],33:[function(require,module,exports){
var slice=[].slice;!function(e,r){"function"==typeof define&&null!=define.amd?define([],r):"undefined"!=typeof exports&&null!==exports?module.exports=r():e.UrlPattern=r()}(this,function(){var e,r,t,n,a,i,s,u,o,l,c,g,f,h,m;return o=function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},s=function(e,r){var t,n,a;for(a=[],t=-1,n=e.length;++t<n;)a=a.concat(r(e[t]));return a},h=function(e,r){var t,n,a;for(a="",t=-1,n=e.length;++t<n;)a+=r(e[t]);return a},f=function(e){return new RegExp(e.toString()+"|").exec("").length-1},c=function(e,r){var t,n,a,i,s;for(i={},t=-1,a=e.length;++t<a;)n=e[t],null!=(s=r[t])&&(null!=i[n]?(Array.isArray(i[n])||(i[n]=[i[n]]),i[n].push(s)):i[n]=s);return i},e={},e.Result=function(e,r){this.value=e,this.rest=r},e.Tagged=function(e,r){this.tag=e,this.value=r},e.tag=function(r,t){return function(n){var a,i;if(null!=(a=t(n)))return i=new e.Tagged(r,a.value),new e.Result(i,a.rest)}},e.regex=function(r){return function(t){var n,a;if(null!=(n=r.exec(t)))return a=n[0],new e.Result(a,t.slice(a.length))}},e.sequence=function(){var r;return r=1<=arguments.length?slice.call(arguments,0):[],function(t){var n,a,i,s,u,o;for(n=-1,a=r.length,o=[],s=t;++n<a;){if(i=r[n],null==(u=i(s)))return;o.push(u.value),s=u.rest}return new e.Result(o,s)}},e.pick=function(){var r,t;return r=arguments[0],t=2<=arguments.length?slice.call(arguments,1):[],function(n){var a,i;if(null!=(i=e.sequence.apply(e,t)(n)))return a=i.value,i.value=a[r],i}},e.string=function(r){var t;return t=r.length,function(n){if(n.slice(0,t)===r)return new e.Result(r,n.slice(t))}},e.lazy=function(e){var r;return r=null,function(t){return null==r&&(r=e()),r(t)}},e.baseMany=function(r,t,n,a,i){var s,u,o;for(u=i,o=n?"":[];;){if(null!=t&&null!=t(u))break;if(null==(s=r(u)))break;n?o+=s.value:o.push(s.value),u=s.rest}if(!a||0!==o.length)return new e.Result(o,u)},e.many1=function(r){return function(t){return e.baseMany(r,null,!1,!0,t)}},e.concatMany1Till=function(r,t){return function(n){return e.baseMany(r,t,!0,!0,n)}},e.firstChoice=function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],function(r){var t,n,a,i;for(t=-1,n=e.length;++t<n;)if(a=e[t],null!=(i=a(r)))return i}},g=function(r){var t;return t={},t.wildcard=e.tag("wildcard",e.string(r.wildcardChar)),t.optional=e.tag("optional",e.pick(1,e.string(r.optionalSegmentStartChar),e.lazy(function(){return t.pattern}),e.string(r.optionalSegmentEndChar))),t.name=e.regex(new RegExp("^["+r.segmentNameCharset+"]+")),t.named=e.tag("named",e.pick(1,e.string(r.segmentNameStartChar),e.lazy(function(){return t.name}))),t.escapedChar=e.pick(1,e.string(r.escapeChar),e.regex(/^./)),t.static=e.tag("static",e.concatMany1Till(e.firstChoice(e.lazy(function(){return t.escapedChar}),e.regex(/^./)),e.firstChoice(e.string(r.segmentNameStartChar),e.string(r.optionalSegmentStartChar),e.string(r.optionalSegmentEndChar),t.wildcard))),t.token=e.lazy(function(){return e.firstChoice(t.wildcard,t.optional,t.named,t.static)}),t.pattern=e.many1(e.lazy(function(){return t.token})),t},u={escapeChar:"\\",segmentNameStartChar:":",segmentValueCharset:"a-zA-Z0-9-_~ %",segmentNameCharset:"a-zA-Z0-9",optionalSegmentStartChar:"(",optionalSegmentEndChar:")",wildcardChar:"*"},i=function(e,r){if(Array.isArray(e))return h(e,function(e){return i(e,r)});switch(e.tag){case"wildcard":return"(.*?)";case"named":return"(["+r+"]+)";case"static":return o(e.value);case"optional":return"(?:"+i(e.value,r)+")?"}},a=function(e,r){return null==r&&(r=u.segmentValueCharset),"^"+i(e,r)+"$"},n=function(e){if(Array.isArray(e))return s(e,n);switch(e.tag){case"wildcard":return["_"];case"named":return[e.value];case"static":return[];case"optional":return n(e.value)}},l=function(e,r,t,n){var a,i,s,u;if(null==n&&(n=!1),null!=(u=e[r])){if(a=t[r]||0,i=Array.isArray(u)?u.length-1:0,!(a>i))return s=Array.isArray(u)?u[a]:u,n&&(t[r]=a+1),s;if(n)throw new Error("too few values provided for key `"+r+"`")}else if(n)throw new Error("no values provided for key `"+r+"`")},t=function(e,r,n){var a,i;if(Array.isArray(e)){for(a=-1,i=e.length;++a<i;)if(t(e[a],r,n))return!0;return!1}switch(e.tag){case"wildcard":return null!=l(r,"_",n,!1);case"named":return null!=l(r,e.value,n,!1);case"static":return!1;case"optional":return t(e.value,r,n)}},m=function(e,r,n){if(Array.isArray(e))return h(e,function(e){return m(e,r,n)});switch(e.tag){case"wildcard":return l(r,"_",n,!0);case"named":return l(r,e.value,n,!0);case"static":return e.value;case"optional":return t(e.value,r,n)?m(e.value,r,n):""}},r=function(e,t){var i,s,o,l;if(e instanceof r)return this.isRegex=e.isRegex,this.regex=e.regex,this.ast=e.ast,void(this.names=e.names);if(this.isRegex=e instanceof RegExp,"string"!=typeof e&&!this.isRegex)throw new TypeError("argument must be a regex or a string");if(this.isRegex){if(this.regex=e,null!=t){if(!Array.isArray(t))throw new Error("if first argument is a regex the second argument may be an array of group names but you provided something else");if(i=f(this.regex),t.length!==i)throw new Error("regex contains "+i+" groups but array of group names contains "+t.length);this.names=t}}else{if(""===e)throw new Error("argument must not be the empty string");if(e.replace(/\s+/g,"")!==e)throw new Error("argument must not contain whitespace");if(s={escapeChar:(null!=t?t.escapeChar:void 0)||u.escapeChar,segmentNameStartChar:(null!=t?t.segmentNameStartChar:void 0)||u.segmentNameStartChar,segmentNameCharset:(null!=t?t.segmentNameCharset:void 0)||u.segmentNameCharset,segmentValueCharset:(null!=t?t.segmentValueCharset:void 0)||u.segmentValueCharset,optionalSegmentStartChar:(null!=t?t.optionalSegmentStartChar:void 0)||u.optionalSegmentStartChar,optionalSegmentEndChar:(null!=t?t.optionalSegmentEndChar:void 0)||u.optionalSegmentEndChar,wildcardChar:(null!=t?t.wildcardChar:void 0)||u.wildcardChar},l=g(s),null==(o=l.pattern(e)))throw new Error("couldn't parse pattern");if(""!==o.rest)throw new Error("could only partially parse pattern");this.ast=o.value,this.regex=new RegExp(a(this.ast,s.segmentValueCharset)),this.names=n(this.ast)}},r.prototype.match=function(e){var r,t;return null==(t=this.regex.exec(e))?null:(r=t.slice(1),this.names?c(this.names,r):r)},r.prototype.stringify=function(e){if(null==e&&(e={}),this.isRegex)throw new Error("can't stringify patterns generated from a regex");if(e!==Object(e))throw new Error("argument must be an object or undefined");return m(this.ast,e,{})},r.escapeForRegex=o,r.concatMap=s,r.stringConcatMap=h,r.regexGroupCount=f,r.keysAndValuesToObject=c,r.P=e,r.newParser=g,r.defaultOptions=u,r.astNodeToRegexString=a,r.astNodeToNames=n,r.getParam=l,r.astNodeContainsSegmentsForProvidedParams=t,r.stringify=m,r});
},{}],34:[function(require,module,exports){
function NodeNetworkRpc(e){var t=this;t.connected=!1,t._queueEmitter=new QueueEmitter,t.network=NodeNetwork(e),t.router=AgnosticRouter(),t._rpc=Rpc(),t.network.on("message",function(e){t._rpcMessage(e)}),t.network.on("address",function(e){t.address=e,void 0===e?(t.connected=!1,t.emit("disconnect")):(t.connected=!0,t.emit("connect"))}),["insert","remove"].forEach(function(e){t.network.on(e,function(){t.emit(e,Array.prototype.slice.call(arguments))})});var o={};this.config=Utils.objectMerge(o,e)}var Rpc=require("agnostic-rpc"),EventEmitter=require("wolfy87-eventemitter"),QueueEmitter=require("queue-emitter"),AgnosticRouter=require("agnostic-router"),NodeNetwork=require("node-network"),Utils=require("./Utils.js");NodeNetworkRpc.prototype.__proto__=EventEmitter.prototype,NodeNetworkRpc.prototype.queueOn=function(){this._queueEmitter.on.apply(this._queueEmitter,Array.prototype.slice.call(arguments))},NodeNetworkRpc.prototype.queueOnce=function(){this._queueEmitter.once.apply(this._queueEmitter,Array.prototype.slice.call(arguments))},NodeNetworkRpc.prototype.request=function(){var e=this;if(void 0===e.address){var t=Array.prototype.slice.call(arguments);e.once("connect",function(){e.request.apply(e,t)})}else{var o=Utils.parseArgs(arguments,[{name:"destAddresses",level:1,validate:function(e,t){return"string"==typeof e&&"/"!=e[0]||Array.isArray(e)}},{name:"path",level:0,validate:function(e,t){return"string"==typeof e&&"/"==e[0]}},{name:"query",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"options",level:2,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),r={query:{path:o.path,query:o.query,srcAddress:this.address},options:o.options};"function"==typeof o.callback?r.responseHandler=function(e,t){"function"==typeof o.callback&&(e?o.callback(e):"object"!=typeof t?o.callback("response_not_object"):o.callback(t.error,t.response))}:r.responseHandler=void 0,r.destAddresses=e.network.normalizeAddresses(o.destAddresses),e._queueEmitter.emit("outgoingRequest",r,function(t){if(t)"function"==typeof r.responseHandler&&r.responseHandler(t);else{var o=e._rpc.request(r.query,r.options,r.responseHandler);e.network.send(r.destAddresses,o)}})}},NodeNetworkRpc.prototype._rpcMessage=function(e){var t=this;t._rpc.messageIsResponse(e)?t._queueEmitter.emit("incomingResponse",e,function(o){t._rpc.handleResponse(e)}):t._queueEmitter.emit("incomingRequest",e,function(o){var r=void 0,n=function(e,o){r=e.srcAddress;var n=function(e,t){o({error:e,response:t})},s=function(){n("not_found",null)};t.router.route("request",e.path,e,n,s)},s=function(e){var o={destAddress:r,message:e};t._queueEmitter.emit("outgoingResponse",o,function(e){e||t.network.send(o.destAddress,o.message)})};t._rpc.handleRequest(e,n,s)})},NodeNetworkRpc.prototype.addConnection=function(e){this.network.addConnection.apply(this.network,Array.prototype.slice.call(arguments))},module.exports=function(e){return new NodeNetworkRpc(e)};
},{"./Utils.js":35,"agnostic-router":32,"agnostic-rpc":4,"node-network":37,"queue-emitter":53,"wolfy87-eventemitter":58}],35:[function(require,module,exports){
arguments[4][31][0].apply(exports,arguments)
},{"dup":31}],36:[function(require,module,exports){
function AddressManager(r){if(!Array.isArray(r))throw new Error("base_address_not_set");this._baseAddress=r,this._max="0",this._stringBase=36}AddressManager.prototype.allocate=function(){return this._max=this._incrementString(this._max,this._stringBase,1),this._baseAddress.concat(this._max)},AddressManager.prototype.addressIsEqual=function(r,s){if(Array.isArray(s)||(s=this._baseAddress),r.length==s.length){var e;for(e=0;e<s.length;e++)if(r[e]!=s[e])return!1;return!0}return!1},AddressManager.prototype.addressIsChild=function(r,s){if(Array.isArray(s)||(s=this._baseAddress),r.length>s.length){var e;for(e=0;e<s.length;e++)if(r[e]!=s[e])return!1;return!0}return!1},AddressManager.prototype.addressIsParent=function(r,s){return Array.isArray(s)||(s=this._baseAddress),this.addressIsChild(s,r)},AddressManager.prototype._incrementString=function(r,s,e){return(parseInt(r,s)+e).toString(s)},module.exports=function(r){return new AddressManager(r)};
},{}],37:[function(require,module,exports){
(function (process){
function NodeRouter(e){"object"!=typeof e&&(e={});var t=this;t.config=e,t._queueEmitter=new QueueEmitter,t._routeTable=RouteTable(),t._routeTable.on("insert",function(e){var r={address:e.address.join("-"),cost:e.cost};t.emit("insert",r)}),t._routeTable.on("remove",function(e){t.emit("remove",e.join("-"))}),t._connections={},t._connectionKeyMax=-1,t._rpc=Rpc(),process.nextTick(function(){t.setAddress(t.config.address)}),t._actions={ping:function(e,t,r){r(null,!0)},route:function(e,r,o){t._route(e,o)},addressrevoke:function(e,r,o){void 0!==t._addressManager&&t._addressManager.addressIsEqual(e)&&t._setAddressParts()},addressrequest:function(e,r,o){if("object"==typeof t._addressManager){o(null,t._addressManager.allocate())}else o("no_address",null)},routesupdate:function(e,r){if(t._routesApplyOperations(e,r),void 0===t.address){var o=function(e){return 0==e.cost},n=t._routeOperationsFilter(e,{insert:o});Array.isArray(n.insert)&&n.insert.length>0&&t.rpcRequest(r,"addressrequest",function(e,o){e?console.error("ADDREQ-FAILED",e):t._setAddressParts(o,r)})}}}}var Rpc=require("agnostic-rpc"),EventEmitter=require("wolfy87-eventemitter"),QueueEmitter=require("queue-emitter"),RouteTable=require("./RouteTable"),AddressManager=require("./AddressManager"),Utils=require("./Utils");NodeRouter.prototype.__proto__=EventEmitter.prototype,NodeRouter.prototype.queueOn=function(){this._queueEmitter.on.apply(this._queueEmitter,Array.prototype.slice.call(arguments))},NodeRouter.prototype.queueOnce=function(){this._queueEmitter.once.apply(this._queueEmitter,Array.prototype.slice.call(arguments))},NodeRouter.prototype.send=function(){var e=this,t=Utils.parseArgs(arguments,[{name:"destAddressesJoined",level:0,validate:function(e,t){return"string"==typeof e||Array.isArray(e)}},{name:"message",level:0},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),r=e.normalizeAddresses(t.destAddressesJoined),o=[];r.forEach(function(e){o.push(e.split("-"))});var n={message:t.message,dest:o};e._queueEmitter.emit("send",n,function(r){r?t.callback(r,null):e._route(n,t.callback)})},NodeRouter.prototype.normalizeAddresses=function(e){return Array.isArray(e)?e:[e]},NodeRouter.prototype.setAddress=function(e,t){if("string"==typeof e){var r=e.split("-");return this._setAddressParts(r,t)}return!1},NodeRouter.prototype._broadcastRouteOperations=function(e){var t=this;Utils.objectForEach(t._connections,function(r,o){t.rpcRequest(o,"routesupdate",e)})},NodeRouter.prototype._routesApplyOperations=function(e,t){var r=this,o=JSON.parse(JSON.stringify(e)),n=function(e){return void 0===r._addressManager||!r._addressManager.addressIsEqual(e.address)},s=r._routeOperationsFilter(o,{insert:n});Array.isArray(s.insert)&&s.insert.forEach(function(e){e.cost=e.cost+1});var a=r._routeTable.modifyRoutes(s,t),n=function(e){return void 0!==r._addressManager&&!r._addressManager.addressIsChild(e.address)};localOperationsBroadcast=r._routeOperationsFilter(a,{insert:n}),Object.keys(localOperationsBroadcast).length&&r._broadcastRouteOperations(localOperationsBroadcast)},NodeRouter.prototype._setAddressParts=function(e,t){var r=this,o={};if(void 0!==r.address){o.remove=[r.address];var n=r._routeTable.childRoutes(this.address);"object"==typeof n&&Utils.objectForEach(n,function(e,t){var o=r.address.concat(t);r._routeTable.removeRoute(o,e.connectionKey),r.rpcRequest(e.connectionKey,"addressrevoke",o)})}r.address=e,r.addressConnectionKey=t,r._addressManager=void 0,void 0!==r.address&&(r._addressManager=AddressManager(r.address),o.insert=[{address:r.address,cost:0}]),Object.keys(o).length&&r._broadcastRouteOperations(o),r.emit("addressParts",r.address);var s=Array.isArray(this.address)?r.address.join("-"):void 0;r.emit("address",s)},NodeRouter.prototype.connectionRouteTableOperations=function(e){var t=this,r=function(r,o){return r.connection!=e&&("object"!=typeof t._addressManager||!t._addressManager.addressIsChild(o))},o=t._routeTable.toRouteOperations(r);return void 0!==t.address&&(Array.isArray(o.insert)||(o.insert=[]),o.insert.push({address:t.address,cost:0})),o},NodeRouter.prototype.addConnection=function(e,t){function r(){var t=o.connectionRouteTableOperations(e);o.rpcRequest(n,"routesupdate",t)}var o=this;o._connectionKeyMax++;var n=o._connectionKeyMax;"object"==typeof t&&null!=t||(t={}),o._connections[n]={connection:e,options:t},e.on("data",function(e){try{o._rpcMessage(n,e)}catch(e){console.error(e)}}),e.on("disconnect",function(){o.addressConnectionKey==n&&o._setAddressParts();var e=o._routeTable.removeConnectionRoutes(n);o._broadcastRouteOperations(e),delete o._connections[n]}),e.on("connect",function(){o._connections[n]={connection:e,options:t},r()}),r()},NodeRouter.prototype._routeOperationsFilter=function(e,t){var r={};return Utils.objectForEach(e,function(e,o){if(Array.isArray(e))if("function"==typeof t[o]){var n=e.filter(t[o]);Array.isArray(n)&&n.length>0&&(r[o]=n)}else r[o]=e}),r},NodeRouter.prototype.rpcBroadcast=function(){var e=this,t=Array.prototype.slice.call(arguments);Utils.objectForEach(e._connections,function(r,o){e.rpcRequest.apply(e,[o].concat(t))})},NodeRouter.prototype.rpcRequest=function(){var e=Utils.parseArgs(arguments,[{name:"connectionKey",level:0},{name:"action",level:0,validate:function(e,t){return"string"==typeof e}},{name:"query",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"callback",level:1,validate:function(e,t){return"function"==typeof e}}]),t=this._rpc.request({action:e.action,query:e.query},function(t,r){"function"==typeof e.callback&&(t?e.callback(t,null):"string"==typeof r.status&&"ok"==r.status?e.callback(null,r.response):"string"==typeof r.status&&e.callback(r.error,r.response))});this._connections[e.connectionKey].connection.emit("data",t)},NodeRouter.prototype._route=function(e,t){function r(){"function"==typeof t&&t.apply(this,Array.prototype.slice.call(arguments))}var o=this,n={};Array.isArray(e.dest)?(e.dest.forEach(function(t){if("object"==typeof o._addressManager&&o._addressManager.addressIsEqual(t))o._queueEmitter.emit("receive",e,function(t){t?r(t,o.address):(o.emit("data",e),o.emit("message",e.message),r(null,o.address))});else{var s=o._routeTable.nextConnection(t);void 0!==s?(Array.isArray(n[s])||(n[s]=[]),n[s].push(t)):r("no_route",null)}}),Utils.objectForEach(n,function(r,n){e.dest=r,o.rpcRequest(n,"route",e,t)})):r("improper_route_format",null)},NodeRouter.prototype._rpcMessage=function(e,t){var r=this;if(r._rpc.messageIsResponse(t))r._rpc.handleResponse(t);else{var o=r._actions;r._rpc.handleRequest(t,function(t,r){var n=function(e,t){r(e?{status:"error",error:e,response:t}:{status:"ok",response:t})};"string"==typeof t.action&&"function"==typeof o[t.action]?o[t.action](t.query,e,n):n("action_not_found",null)},function(t){if(r._connections[e]){r._connections[e].connection.emit("data",t)}})}},module.exports=function(e){return new NodeRouter(e)};
}).call(this,require('_process'))

},{"./AddressManager":36,"./RouteTable":38,"./Utils":40,"_process":52,"agnostic-rpc":4,"queue-emitter":53,"wolfy87-eventemitter":58}],38:[function(require,module,exports){
function RouteTable(){this.table=Tree()}var Utils=require("./Utils"),Tree=require("./Trie"),EventEmitter=require("wolfy87-eventemitter");RouteTable.prototype.toRouteOperations=function(e){var t=[];return this.table.traverse(function(r,o){("function"!=typeof e||e(r,o))&&t.push({address:o,cost:r.cost})}),0==t.length?{}:{insert:t}},RouteTable.prototype.__proto__=EventEmitter.prototype,RouteTable.prototype.childRoutes=function(e){return this.table.children(e)},RouteTable.prototype.nextConnection=function(e){var t=this.table.deepest(e);return"object"==typeof t?t.data.connectionKey:void 0},RouteTable.prototype.removeConnectionRoutes=function(e){var t=[];return this.table.traverse(function(r,o){r.connectionKey==e&&t.push(o)}),this.modifyRoutes({remove:t},e)},RouteTable.prototype.modifyRoutes=function(e,t){var r=this,o={};return Array.isArray(e.remove)&&e.remove.forEach(function(e){Array.isArray(e)&&r.removeRoute(e,t)&&(Array.isArray(o.remove)||(o.remove=[]),o.remove.indexOf(e)<0&&o.remove.push(e),r.emit("remove",e))}),Array.isArray(e.insert)&&e.insert.forEach(function(e){Array.isArray(e.address)&&"number"==typeof e.cost&&r.insertRoute(e.address,t,e.cost)&&(Array.isArray(o.insert)||(o.insert=[]),o.insert.indexOf(e)<0&&o.insert.push(e),r.emit("insert",e))}),o},RouteTable.prototype.insertRoute=function(e,t,r){var o=this.table.get(e);return(void 0===o||o.cost>r||o.connectionKey==t)&&(this.table.set(e,{cost:r,connectionKey:t}),!0)},RouteTable.prototype.removeRoute=function(e,t){var r=this.table.get(e);return"object"==typeof r&&r.connectionKey==t&&this.table.remove(e)},module.exports=function(){return new RouteTable};
},{"./Trie":39,"./Utils":40,"wolfy87-eventemitter":58}],39:[function(require,module,exports){
function Trie(){this.trie={}}var Utils=require("./Utils");Trie.prototype.get=function(e){var t=this.getNode(e);return"object"==typeof t&&void 0!==t.data?t.data:void 0},Trie.prototype.getNode=function(e){var t=this.trie;for(var r in e){if("object"!=typeof t.children||"object"!=typeof t.children[e[r]])return;t=t.children[e[r]]}return t},Trie.prototype.set=function(e,t){var r=this.trie;for(var o in e)"object"!=typeof r.children&&(r.children={}),"object"!=typeof r.children[e[o]]&&(r.children[e[o]]={}),r=r.children[e[o]];r.data=t},Trie.prototype.remove=function(e){var t=this.inPathNodes(e);if(t.length!=e.length+1)return!1;var r=t.pop();if(delete r.node.data,"object"==typeof r.node.children&&Object.keys(r.node.children).length>0)return!0;r.path.length>0&&delete t[t.length-1].node.children[r.path.pop()];for(var o=t.length-1;o>=0;o--){if("object"==typeof t[o].node.children&&0==Object.keys(t[o].node.children).length&&delete t[o].node.children,void 0!==t[o].node.data||"object"==typeof t[o].node.children&&Object.keys(t[o].node.children).length>0)return!0;o>0&&delete t[o-1].node.children[t[o].path.pop()]}return!0},Trie.prototype.removeNode=function(e){var t=this.inPathNodes(e);if(t.length!=e.length+1)return!1;var r=t.pop();delete r.node.data,r.path.length>0&&delete t[t.length-1].node.children[r.path.pop()];for(var o=t.length-1;o>=0;o--){if("object"==typeof t[o].node.children&&0==Object.keys(t[o].node.children).length&&delete t[o].node.children,void 0!==t[o].node.data||"object"==typeof t[o].node.children&&Object.keys(t[o].node.children).length>0)return!0;void 0!==t[o-1]&&delete t[o-1].node.children[t[o].path.pop()]}return!0},Trie.prototype.children=function(e){var t=this.childrenNodes(e);if(void 0!==t){var r={};return Utils.objectForEach(t,function(e,t){void 0!==e.data&&(r[t]=e.data)}),r}},Trie.prototype.childrenNodes=function(e){var t=this.getNode(e);return"object"!=typeof t?void 0:"object"!=typeof t.children?{}:t.children},Trie.prototype.traverse=function(e,t,r){this.traverseNodes(function(t,r){void 0!==t.data&&e(t.data,r)},t,r)},Trie.prototype.traverseNodes=function(e,t,r){if(!Array.isArray(r))var r=[];if("object"!=typeof t)var t=this.trie;if(e(t,r),t.children,!0){var o;for(o in t.children)t.children.hasOwnProperty(o)&&this.traverseNodes(e,t.children[o],r.concat(o))}},Trie.prototype.deepest=function(e){var t=void 0,r=void 0;return this.descend(e,function(e,o){t=e,r=o}),void 0===r?void 0:{pathKeys:r,data:t}},Trie.prototype.descend=function(e,t){this.descendNodes(e,function(e,r){void 0!==e.data&&t(e.data,r)})},Trie.prototype.descendNodes=function(e,t){var r=this.trie;t(r,[]);for(var o=0;o<e.length;o++){if("object"!=typeof r.children||"object"!=typeof r.children[e[o]])return;r=r.children[e[o]],t(r,e.slice(0,o+1))}},Trie.prototype.inPathNodes=function(e){var t=[];return this.descend(e,function(e,r){t.push({path:r,data:e})}),t},Trie.prototype.inPathNodes=function(e){var t=[];return this.descendNodes(e,function(e,r){t.push({path:r,node:e})}),t},module.exports=function(){return new Trie};
},{"./Utils":40}],40:[function(require,module,exports){
arguments[4][31][0].apply(exports,arguments)
},{"dup":31}],41:[function(require,module,exports){
var $3_BITS=16777215,$5_BITS=0xffffffffff,MACHINE_ID_AND_PID=Math.round(Math.random()*$5_BITS),index=0,Index=function(){return index+=1%$3_BITS},Timestamp=function(){return Math.floor(new Date/1e3)},pad=function(t,n){for(;t.length<n;)t="0"+t;return t},makeObjectId=function(){return[[Timestamp(),8],[MACHINE_ID_AND_PID,10],[Index(),6]].reduce(function(t,n){return t+pad(n[0].toString(16),n[1])},"")},objIdPattern=/^[0-9a-fA-F]{24}$/,isValid=function(t){return!!t&&"function"==typeof t.toString&&objIdPattern.test(t.toString())};module.exports=makeObjectId,module.exports.isValid=isValid;
},{}],42:[function(require,module,exports){
var FunctionUtils={};FunctionUtils.objectPublicFunctions=function(n){return function(n){var t=[];for(var i in n)"function"==typeof n[i]&&t.push(i);return t}(n).filter(function(n){return"_"!==n[0]&&"globalFunctions"!==n})},FunctionUtils.objectReplicateFunctions=function(n,t,i){Array.isArray(i)||(i=[]),FunctionUtils.objectPublicFunctions(n).forEach(function(o){void 0===t[o]&&i.indexOf(o)<0&&(t[o]=function(){n[o].apply(n,Array.prototype.slice.call(arguments))})})},module.exports=FunctionUtils;
},{}],43:[function(require,module,exports){
module.exports={OmsIntercept:require("./OmsIntercept"),OmsLayers:require("./OmsLayers"),OmsMongoConnector:require("./OmsMongoConnector"),OmsOplog:require("./OmsOplog"),OmsOplogSubscriptions:require("./OmsOplogSubscriptions"),OmsSubscriptions:require("./OmsSubscriptions"),OmsUtils:require("./OmsUtils")};
},{"./OmsIntercept":44,"./OmsLayers":45,"./OmsMongoConnector":46,"./OmsOplog":47,"./OmsOplogSubscriptions":48,"./OmsSubscriptions":49,"./OmsUtils":50}],44:[function(require,module,exports){
function OmsIntercept(t){this.collection=t,this._maxOpId=0,this._replicateInterceptCollectionFunctions()}var QueueEmitter=require("queue-emitter"),FunctionUtils=require("./FunctionUtils");OmsIntercept.prototype.__proto__=QueueEmitter.prototype,OmsIntercept.prototype._replicateInterceptCollectionFunctions=function(){var t=this,n=["isCapped"];FunctionUtils.objectPublicFunctions(this.collection).forEach(function(o){void 0===t[o]&&n.indexOf(o)<0&&(t[o]=function(){t._collectionFunction(o,Array.prototype.slice.call(arguments))})})},OmsIntercept.prototype._collectionFunction=function(t,n){function o(o){null!==o?c(o):r.collection[t].apply(r.collection,n.concat([c]))}function c(){l=Array.prototype.slice.call(arguments),r.emit.apply(r,[t].concat(p).concat(l).concat([e]))}function e(t){if("function"==typeof u){var n=Array.prototype.slice.call(arguments);n.shift(),i()}}function i(){"function"==typeof u&&u.apply(r,l)}var r=this,p=r._maxOpId,l=void 0;if(r._maxOpId++,Array.isArray(n)&&n.length>0&&"function"==typeof n[n.length-1])var u=n.pop();r.emit.apply(r,["pre-"+t].concat(p).concat(n).concat([o]))},OmsIntercept.prototype._objectPublicFunctions=function(t){return function(t){var n=[];for(var o in t)"function"==typeof t[o]&&n.push(o);return n}(t).filter(function(t){return"_"!==t[0]&&"globalFunctions"!==t})},module.exports=function(t){return new OmsIntercept(t)};
},{"./FunctionUtils":42,"queue-emitter":53}],45:[function(require,module,exports){
function OmsLayers(e,o){var t=this;t.cacheCollection=e,t.masterCollection=o,FunctionUtils.objectReplicateFunctions(t.masterCollection,t),t.masterCollection.on("insert",function(e,o){t.cacheCollection.insert(e,o)}),t.masterCollection.on("update",function(e,o,n,i){t.cacheCollection.update({_id:e._id},n,i)}),t.masterCollection.on("remove",function(e,o){t.cacheCollection.remove({_id:e._id})})}var FunctionUtils=require("./FunctionUtils");module.exports=function(e,o){return new OmsLayers(e,o)};
},{"./FunctionUtils":42}],46:[function(require,module,exports){
function OmsMongoConnector(e){var t=this;this.operationsQueue=[],this.mongoIntercept=OmsIntercept(e),FunctionUtils.objectReplicateFunctions(t.mongoIntercept,t);var n=null;t.mongoIntercept.on("pre-insert",function(){var e=Utils.parseArgs(arguments,[{name:"opId",level:0,validate:function(e,t){return void 0!==e}},{name:"docs",level:0,validate:function(e,t){return"object"==typeof e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"next",level:0,validate:function(e,t){return"function"==typeof e}}]);t.queue(function(o){n=o,t._docs=e.docs,e.next()})}),t.mongoIntercept.on("insert",function(e,o,i){var r=arguments[arguments.length-1];Array.isArray(t._docs)||(t._docs=[t._docs]),t._docs.forEach(function(e){t.emit("insert",e)}),delete t.docs,n(),r()}),t.mongoIntercept.on("pre-update",function(){var e=Utils.parseArgs(arguments,[{name:"opId",level:0,validate:function(e,t){return void 0!==e}},{name:"query",level:1,validate:function(e,t){return"object"==typeof e||"string"==typeof e},default:{}},{name:"updateOperations",level:0,validate:function(e,t){return"object"==typeof e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"next",level:1,validate:function(e,t){return"function"==typeof e}}]);"string"==typeof e.query&&(e.query={_id:e.query}),t.queue(function(o){function i(n,o){n?e.next(n):(t._unmodifiedDocs={},o.forEach(function(e){t._unmodifiedDocs[e._id]=t._cloneObject(e)}),t._updateOperations=e.updateOperations,e.next())}n=o,"object"==typeof e.options&&e.options.multi?t.mongoIntercept.find(e.query,i):t.mongoIntercept.findOne(e.query,function(e,t){i(e,[t])})})}),t.mongoIntercept.on("update",function(){var e=arguments[arguments.length-1],o=t._validateUpdate(t._updateOperations);Utils.objectForEach(t._unmodifiedDocs,function(e){var n=t._updateDoc(e,o,!0);t.emit("update",e,n,t._updateOperations)}),delete t._unmodifiedDocs,delete t._updateOperations,n(),e()}),t.mongoIntercept.on("pre-remove",function(){var e=Utils.parseArgs(arguments,[{name:"opId",level:0,validate:function(e,t){return void 0!==e}},{name:"query",level:1,validate:function(e,t){return"object"==typeof e||"string"==typeof e},default:{}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}},{name:"next",level:1,validate:function(e,t){return"function"==typeof e}}]);"string"==typeof e.query&&(e.query={_id:e.query}),t.queue(function(o){n=o,t.mongoIntercept.find(e.query,function(n,o){n?e.next(n):(t._unmodifiedDocs={},o.forEach(function(e){t._unmodifiedDocs[e._id]=t._cloneObject(e)}),e.next())})})}),t.mongoIntercept.on("remove",function(){var e=arguments[arguments.length-1];Utils.objectForEach(t._unmodifiedDocs,function(e){t.emit("remove",e)}),delete t._unmodifiedDocs,n(),e()})}var EventEmitter=require("wolfy87-eventemitter"),FauxMongo=require("fauxmongo"),OmsIntercept=require("./OmsIntercept"),OmsSubscriptions=require("./OmsSubscriptions"),Utils=require("./Utils"),FunctionUtils=require("./FunctionUtils");OmsMongoConnector.prototype.__proto__=EventEmitter.prototype,OmsMongoConnector.prototype.queue=function(e){var t=this,n=function(){t.operationsQueue.shift(),t.operationsQueue.length&&t.operationsQueue[0]()};t.operationsQueue.push(e),1==t.operationsQueue.length&&e(n)},OmsMongoConnector.prototype._validateUpdate=function(e){var t={};return Utils.objectForEach(e,function(e,n){"$set"==n?t.$set=Utils.objectMerge(t.$set,n):"$"==n.charAt(0)?t[n]=e:("object"==typeof t.$set&&null!=t.$set||(t.$set={}),t.$set[n]=e)}),t},OmsMongoConnector.prototype._updateDoc=function(e,t,n){"boolean"==typeof n&&n&&(e=this._cloneObject(e));var o={};return Utils.objectForEach(t,function(t,n){"$"==n.charAt(0)?o[n]=t:e[n]=t}),FauxMongo.update(e,o),e},OmsMongoConnector.prototype._cloneObject=function(e){return JSON.parse(JSON.stringify(e))},module.exports=function(e){return new OmsMongoConnector(e)};
},{"./FunctionUtils":42,"./OmsIntercept":44,"./OmsSubscriptions":49,"./Utils":51,"fauxmongo":9,"wolfy87-eventemitter":58}],47:[function(require,module,exports){
function OmsOplog(o,i,t){var n=this;n.docCollection=o,n.opLogCollection=MongoLocal(i),n.docsLinkedList=n.opLogCollection.docsLinkedList,FunctionUtils.objectReplicateFunctions(n.opLogCollection,n),["insert","update","remove"].forEach(function(i){o.on(i,function(){var o=OmsUtils.operationObject(i,arguments),e=OmsUtils.operationDoc(o);if("object"==typeof o.options&&void 0!==o.options._operation){var l=o.options._operation;delete o.options._operation,void 0===l._id&&void 0!==l._srcId&&(e._id=l._srcOpId),e.src="applied"}else e=Utils.objectMerge(t,e,{src:"local"});n.opLogCollection.insert(e)})})}var MongoLocal=require("mongolocal"),FunctionUtils=require("./FunctionUtils"),OmsUtils=require("./OmsUtils"),Utils=require("./Utils");OmsOplog.prototype.applyOp=function(o){function i(o){Utils.objectSet(o.operation,["options","_operation"],o);var i=OmsUtils.operationFunctionArguments(o.operation);"function"==typeof t.docCollection[o.operation.operation]&&t.docCollection[o.operation.operation].apply(t.docCollection,i)}var t=this;if(void 0===o)throw new Error("operation_undefined");var n=void 0!==o._id?o._id:o._srcOpId;void 0!==n?t.opLogCollection.findOne({_id:n},function(t,n){t||null!=n||i(o)}):i(o)},module.exports=function(o,i,t){return new OmsOplog(o,i,t)};
},{"./FunctionUtils":42,"./OmsUtils":50,"./Utils":51,"mongolocal":29}],48:[function(require,module,exports){
function OmsOplogSubscriptions(o){var i=this;i.opLogCollection=o,i.docCollection=o.docCollection,i._oneSubscriptions={},i._collectionSubscriptions={},i._collectionQueries={},i._opLogQueries={},i.opLogCollection.on("insert",function(o){i._publish(o)})}var OmsSubscriptions=require("./OmsSubscriptions"),OmsUtils=require("./OmsUtils");OmsOplogSubscriptions.prototype.subscribeOneResume=function(o,i,t,e){},OmsOplogSubscriptions.prototype.findSubscribeOne=function(o,i,t){function e(e){var c=s._objectMerge(o,{_id:e});s.findSubscribe(c,i,function(o,i){o?t(o):"subscribe"==i.operation.operation?"subscribed"==i.operation.status?u.collectionSubscription=i.operation.options.subscriptionId:"find-complete"!=i.operation.status||r||(r=!0,t(null,i)):(t(null,i),"remove"==i.operation.operation&&s.unsubscribe(null,function(){n()}))})}function n(){s.findSubscribe(o,i,function(o,i){if(o)t(o);else if("subscribe"==i.operation.operation)"subscribed"==i.operation.status?u.collectionSubscription=i.operation.options.subscriptionId:"find-complete"!=i.operation.status||r||(r=!0,t(null,i));else if("insert"==i.operation.operation){var n=i.operation.doc._id;s.unsubscribe(u.collectionSubscription,function(){e(n)})}})}var s=this,r=!1,c=s._uniqueId();s._oneSubscriptions[c]={};var u=s._oneSubscriptions[c],l=OmsUtils.operationObject("subscribe",["subscribed",{subscriptionId:c}]);t(null,OmsUtils.operationDoc(l)),"string"==typeof o._id?e(o._id):n()},OmsOplogSubscriptions.prototype.subscribeResume=function(o,i,t,e){var n=this;n.opLogCollection.findOne({_id:o},function(s,r){function c(){null==u?n.subscribe(i,t,e):n.opLogCollection.findOne({_id:u.data},function(o,s){if(o)e(o,null);else{var r=n.opLogSubscriptionComputedDoc(s,t,i);null!=r&&e(null,r),u=u.next,c()}})}if(s&&e(s,null),null==r)e("last_op_not_found",null);else{var u=n.opLogCollection.docsLinkedList.list[o];u=u.next,c()}})},OmsOplogSubscriptions.prototype.opLogSubscriptionComputedDoc=function(o,i,t){return OmsUtils.docMatch(o,i)?this.operationSubscriptionComputedDoc(o,t):null},OmsOplogSubscriptions.prototype.operationSubscriptionComputedDoc=function(o,i){switch(o.operation.operation){case"insert":case"remove":if(OmsUtils.docMatch(o.operation.doc,i))return this._objectMerge(o,{src:"subscription"});break;case"update":var t=OmsUtils.docMatch(o.operation.unmodifiedDoc,i),e=OmsUtils.docMatch(o.operation.modifiedDoc,i);if(t&&e)return o;if(t&&!e)var n=OmsUtils.operationObject("remove",[o.operation.unmodifiedDoc]);else{if(t||!e)return null;var n=OmsUtils.operationObject("insert",[o.operation.modifiedDoc])}var s=OmsUtils.operationDoc(n);return this._objectMerge(s,{_srcOpId:o._id,src:"subscription_translated"});default:throw new Error("unknown_event")}return null},OmsOplogSubscriptions.prototype.findSubscribe=function(o,i,t){function e(){t.apply(n,Array.prototype.slice.call(arguments))}var n=this;n.docCollection.find(o,function(s,r){if(s)t(s,null);else{n.subscribe(o,i,e),r.forEach(function(o){var i=OmsUtils.operationObject("insert",[o]),e=n._objectMerge(OmsUtils.operationDoc(i),{src:"subscription_setup"});t(null,e)});var c=OmsUtils.operationObject("subscribe",["find-complete"]);t(null,OmsUtils.operationDoc(c))}})},OmsOplogSubscriptions.prototype.subscribe=function(o,i,t){var e=this._queryKey(this._collectionQueries,o);this._collectionQueries[e].usages++;var n=this._queryKey(this._opLogQueries,i);this._opLogQueries[n].usages++;var s=this._uniqueId();this._collectionSubscriptions[s]={collectionQueryKey:e,opLogQueryKey:n,callback:t};var r=OmsUtils.operationObject("subscribe",["subscribed",{subscriptionId:s}]);return t(null,OmsUtils.operationDoc(r)),s},OmsOplogSubscriptions.prototype.unsubscribe=function(o,i){function t(o,t){"function"==typeof i&&i(o,t)}if("object"==typeof this._oneSubscriptions[o]){var e=this._oneSubscriptions[o];"string"==typeof e.collectionSubscription?this.unsubscribe(e.collectionSubscription,function(i,e){i?t(i,null):(delete this._oneSubscriptions[o],t(null,!0))}):(delete this._oneSubscriptions[o],t(null,!0))}else if("object"==typeof this._collectionSubscriptions[o]){var e=this._collectionSubscriptions[o],n=e.collectionQueryKey,s=this._collectionQueries[n];s.usages--,s.usages<=0&&delete this._collectionQueries[n];var r=e.opLogQueryKey,c=this._opLogQueries[r];c.usages--,c.usages<=0&&delete this._opLogQueries[r],t(null,!0)}else t("subscription_not_found",null)},OmsOplogSubscriptions.prototype._publish=function(o){var i=this,t={},e={};this._objectForEach(i._collectionSubscriptions,function(n,s){var r=n.collectionQueryKey;if("object"==typeof i._collectionQueries[r]){var c=i._collectionQueries[r].query,u=n.opLogQueryKey,l=i._opLogQueries[u].query;"boolean"!=typeof e[u]&&(e[u]=OmsUtils.docMatch(o,l)),e[u]&&("boolean"!=typeof t[r]&&(t[r]=i.operationSubscriptionComputedDoc(o,c)),null!=t[r]&&n.callback(null,t[r]))}})},OmsOplogSubscriptions.prototype._queryKey=function(o,i){var t;for(t in o)if(o.hasOwnProperty(t)&&this._objectDeepEqual(o[t].query,i))return t;var e=this._uniqueId();return o[e]={usages:0,query:i},e},OmsOplogSubscriptions.prototype._uniqueId=function(){function o(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return o()+o()+"-"+o()+"-"+o()+"-"+o()+"-"+o()+o()+o()},OmsOplogSubscriptions.prototype._objectDeepEqual=function(o,i){if("object"==typeof o&&null!=o&&"object"==typeof i&&null!=i){if(Object.keys(o).length!=Object.keys(i).length)return!1;for(var t in o){if(!i.hasOwnProperty(t))return!1;if(!this._objectDeepEqual(o[t],i[t]))return!1}return!0}return o===i},OmsOplogSubscriptions.prototype._objectForEach=function(o,i){var t;for(t in o)o.hasOwnProperty(t)&&i(o[t],t,o)},OmsOplogSubscriptions.prototype._objectMerge=function(){var o={};return this._objectForEach(arguments,function(i){for(var t in i)i.hasOwnProperty(t)&&(o[t]=i[t])}),o},module.exports=function(o){return new OmsOplogSubscriptions(o)};
},{"./OmsSubscriptions":49,"./OmsUtils":50}],49:[function(require,module,exports){
function OmsSubscriptions(t){this.opLogSubscriptions=t,this.docCollection=t.docCollection}var OmsUtils=require("./OmsUtils");OmsSubscriptions.prototype.findSubscribeOneObject=function(){var t="function"==typeof arguments[1]?arguments[0]:{},n="function"==typeof arguments[0]?arguments[0]:arguments[1];return this.opLogSubscriptions.findSubscribeOne(t,{},function(t,o){t?n(t):n(t,o.operation)})},OmsSubscriptions.prototype.findSubscribeOne=function(){var t="function"==typeof arguments[0]?{}:arguments[0],n="function"==typeof arguments[0]?arguments[0]:arguments[1];this.findSubscribeOneObject(t,function(t,o){t?n(t):n.apply(this,[t,o.operation].concat(OmsUtils.operationFunctionArguments(o)))})},OmsSubscriptions.prototype.findSubscribeObject=function(){var t="function"==typeof arguments[1]?arguments[0]:{},n="function"==typeof arguments[0]?arguments[0]:arguments[1];return this.opLogSubscriptions.findSubscribe(t,{},function(t,o){t?n(t):n(t,o.operation)})},OmsSubscriptions.prototype.subscribeObject=function(){var t="function"==typeof arguments[1]?arguments[0]:{},n="function"==typeof arguments[0]?arguments[0]:arguments[1];return this.opLogSubscriptions.subscribe(t,{},function(t,o){t?n(t):n(t,o.operation)})},OmsSubscriptions.prototype.findSubscribe=function(){var t="function"==typeof arguments[0]?{}:arguments[0],n="function"==typeof arguments[0]?arguments[0]:arguments[1];this.findSubscribeObject(t,function(t,o){t?n(t):n.apply(this,[t,o.operation].concat(OmsUtils.operationFunctionArguments(o)))})},OmsSubscriptions.prototype.subscribe=function(){var t="function"==typeof arguments[0]?{}:arguments[0],n="function"==typeof arguments[0]?arguments[0]:arguments[1];this.subscribeObject(t,function(t,o){t?n(t):n.apply(this,[t,o.operation].concat(OmsUtils.operationFunctionArguments(o)))})},OmsSubscriptions.prototype.unsubscribe=function(t,n){return this.opLogSubscriptions.unsubscribe(t,function(t,o){"function"==typeof n&&n(t,o)})},module.exports=function(t){return new OmsSubscriptions(t)};
},{"./OmsUtils":50}],50:[function(require,module,exports){
var FauxMongo=require("fauxmongo"),OmsUtils={};OmsUtils.docMatch=function(o,t){return FauxMongo.matchQuery(o,t)},OmsUtils.operationFunctionArguments=function(o){switch(o.operation){case"insert":return[o.doc,o.options];case"update":return[{_id:o.unmodifiedDoc._id},o.updateOperation,o.options];case"remove":return[{_id:o.doc._id},o.options];case"subscribe":return[o.status,"object"==typeof o.options&&null!=o.options?o.options:{}];default:throw new Error("undefined_operation_type")}},OmsUtils.operationDoc=function(o){return{date:new Date,operation:o}},OmsUtils.operationDocMin=function(o){return{_id:o._id,operation:OmsUtils.operationObjectMin(o.operation)}},OmsUtils.operationObjectMin=function(o){switch(o.operation){case"remove":return{operation:o.operation,doc:{_id:o.doc._id},options:o.options};case"update":return{operation:o.operation,unmodifiedDoc:{_id:o.unmodifiedDoc._id},updateOperation:o.updateOperation,options:o.options};case"insert":case"subscribe":default:return o}},OmsUtils.operationObject=function(o,t){switch(o){case"insert":case"remove":return{operation:o,doc:t[0],options:"object"!=typeof t[1]&&null==t[1]?{}:t[1]};case"update":return{operation:o,unmodifiedDoc:t[0],modifiedDoc:t[1],updateOperation:t[2],options:"object"!=typeof t[3]||null==t[3]?{}:t[3]};case"subscribe":return{operation:o,status:t[0],options:"object"!=typeof t[1]||null==t[1]?{}:t[1]};default:throw new Error("undefined_operation_type")}},module.exports=OmsUtils;
},{"fauxmongo":9}],51:[function(require,module,exports){
var Utils={};Utils.objectFilterProperties=function(e,t){var n={};return t.forEach(function(t){n[t]=e[t]}),n},Utils.objectDeepEqual=function(e,t){if("object"==typeof e&&null!=e&&"object"==typeof t&&null!=t){if(Object.keys(e).length!=Object.keys(t).length)return!1;for(var n in e){if(!t.hasOwnProperty(n))return!1;if(!Utils.objectDeepEqual(e[n],t[n]))return!1}return!0}return e===t},Utils.objectContainsObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)&&(!e.hasOwnProperty(n)||e[n]!=t[n]))return!1;return!0},Utils.objectFilter=function(e,t){var n={};return this.objectForEach(e,function(e,r,o){t(e,r,o)&&(n[r]=e)}),n},Utils.objectForEach=function(e,t){var n;for(n in e)e.hasOwnProperty(n)&&t(e[n],n,e)},Utils.objectGet=function(e,t){var n=this;if(0==t.length)return e;if("object"==typeof e){if(("string"==typeof t[0]||"number"==typeof t[0])&&null!==e&&e.hasOwnProperty(t[0]))return this.objectGet(e[t[0]],t.slice(1));if(null===t[0]){if(Array.isArray(e)){var r=[];e.forEach(function(e,o){r[o]=n.objectGet(e,t.slice(1))})}else{var r={};this.objectForEach(e,function(e,o){r[o]=n.objectGet(e,t.slice(1))})}return r}if(t[0]instanceof RegExp){var r={};return this.objectForEach(e,function(e,o){o.match(t[0])&&(r[o]=n.objectGet(e,t.slice(1)))}),r}if("function"==typeof t[0]){if(e instanceof Array){var r=[];e.forEach(function(e,o,i){t[0](e,o,i)&&(r[o]=n.objectGet(e,t.slice(1)))})}else{var r={};this.objectForEach(n.objectFilter(e,t[0]),function(e,o){r[o]=n.objectGet(e,t.slice(1))})}return r}if(t[0]instanceof Array){if(e instanceof Array){var r=[];t[0].forEach(function(t,n){r[n]=e[n]})}else{var r={};this.objectForEach(n.objectFilterProperties(e,t[0]),function(e,o){r[o]=n.objectGet(e,t.slice(1))})}return r}}},Utils.objectSet=function(e,t,n){return 1==t.length?(e[t[0]]=n,!0):(void 0===e[t[0]]&&(e[t[0]]={}),this.objectSet(e[t[0]],t.slice(1),n))},Utils.objectIsset=function(e,t){return 1==t.length?void 0!==e[t[0]]:void 0!==e[t[0]]&&this.objectIsset(e[t[0]],t.slice(1))},Utils.objectMerge=function(){var e={};return this.objectForEach(arguments,function(t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}),e},Utils.uniqueId=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},Utils.parseArgs=function(e,t){function n(e,t){return"function"!=typeof e.validate||e.validate(t)}function r(e,t){for(var n=t;n<e.length;n++)if(void 0===e[n]||!e[n].required)return!0;return!1}var o={},i=0;return Array.isArray(e)||(e=Array.prototype.slice.call(e)),e.forEach(function(e,c){for(var u=i;u<t.length;u++){if(t[u].required){if(n(t[u],e)){t[u].matched=!0,o[t[u].name]=e,i++;break}throw"missing_required"}if(!t[u].required&&(r(t,u)||t[u].level>t[u-1].level&&t[u-1].matched)&&n(t[u],e)){t[u].matched=!0,o[t[u].name]=e,i++;break}t[u].matched=!1,i++}}),t.forEach(function(e){void 0===o[e.name]&&void 0!==e.default&&(o[e.name]=e.default)}),o},Utils.callbackQueue=function(){function e(){r||(r=!0,n.queueCompleteCallback.apply(this,Array.prototype.slice.call(arguments)))}function t(){o++,"function"==typeof n.queueFunctions[o]?Array.isArray(n.queueFunctionArgs)&&!n.options.expand?n.queueFunctions[o](n.queueFunctionArgs,t,e):Array.isArray(n.queueFunctionArgs)&&n.options.expand?n.queueFunctions[o].apply(this,n.queueFunctionArgs.concat([t,e])):n.queueFunctions[o](t,e):"function"!=typeof n.queueNoMatchCallback||r||n.queueNoMatchCallback()}var n=Utils.parseArgs(arguments,[{name:"queueFunctions",level:0,validate:function(e,t){return Array.isArray(e)}},{name:"queueFunctionArgs",level:1,validate:function(e,t){return Array.isArray(e)}},{name:"queueCompleteCallback",level:0,validate:function(e,t){return"function"==typeof e}},{name:"queueNoMatchCallback",level:1,validate:function(e,t){return"function"==typeof e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}}]);n.options=Utils.objectMerge({expand:!1},n.options);var r=!1,o=-1;t()},module.exports=Utils;
},{}],52:[function(require,module,exports){
function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(e){if(cachedSetTimeout===setTimeout)return setTimeout(e,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(e,0);try{return cachedSetTimeout(e,0)}catch(t){try{return cachedSetTimeout.call(null,e,0)}catch(t){return cachedSetTimeout.call(this,e,0)}}}function runClearTimeout(e){if(cachedClearTimeout===clearTimeout)return clearTimeout(e);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(e);try{return cachedClearTimeout(e)}catch(t){try{return cachedClearTimeout.call(null,e)}catch(t){return cachedClearTimeout.call(this,e)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var e=runTimeout(cleanUpNextTick);draining=!0;for(var t=queue.length;t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}var process=module.exports={},cachedSetTimeout,cachedClearTimeout;!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var queue=[],draining=!1,currentQueue,queueIndex=-1;process.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(e){return[]},process.binding=function(e){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(e){throw new Error("process.chdir is not supported")},process.umask=function(){return 0};
},{}],53:[function(require,module,exports){
function QueueEmitter(){}var EventEmitter=require("wolfy87-eventemitter");QueueEmitter.prototype.__proto__=EventEmitter.prototype,QueueEmitter.prototype.emit=function(){var t=this,e=Array.prototype.slice.call(arguments),o=e.shift(),i=e.pop(),n=t.getListeners(o),r=[];n.forEach(function(t){r.push(t.listener)}),this._callbackQueue(r,e,function(e){n.filter(function(t){return t.once}).forEach(function(e){t.off(o,e.listener)}),"function"==typeof i&&i(void 0===e?null:e)})},QueueEmitter.prototype._callbackQueue=function(t,e,o){function i(r){n++,void 0!==r||"function"!=typeof t[n]?o(r):t[n].apply(this,e.concat([i]))}var n=-1;i()},module.exports=QueueEmitter;
},{"wolfy87-eventemitter":58}],54:[function(require,module,exports){
arguments[4][33][0].apply(exports,arguments)
},{"dup":33}],55:[function(require,module,exports){
"function"==typeof Object.create?module.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(t,e){t.super_=e;var o=function(){};o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t};
},{}],56:[function(require,module,exports){
module.exports=function(o){return o&&"object"==typeof o&&"function"==typeof o.copy&&"function"==typeof o.fill&&"function"==typeof o.readUInt8};
},{}],57:[function(require,module,exports){
(function (process,global){
function inspect(e,r){var t={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(t.depth=arguments[2]),arguments.length>=4&&(t.colors=arguments[3]),isBoolean(r)?t.showHidden=r:r&&exports._extend(t,r),isUndefined(t.showHidden)&&(t.showHidden=!1),isUndefined(t.depth)&&(t.depth=2),isUndefined(t.colors)&&(t.colors=!1),isUndefined(t.customInspect)&&(t.customInspect=!0),t.colors&&(t.stylize=stylizeWithColor),formatValue(t,e,t.depth)}function stylizeWithColor(e,r){var t=inspect.styles[r];return t?"["+inspect.colors[t][0]+"m"+e+"["+inspect.colors[t][1]+"m":e}function stylizeNoColor(e,r){return e}function arrayToHash(e){var r={};return e.forEach(function(e,t){r[e]=!0}),r}function formatValue(e,r,t){if(e.customInspect&&r&&isFunction(r.inspect)&&r.inspect!==exports.inspect&&(!r.constructor||r.constructor.prototype!==r)){var n=r.inspect(t,e);return isString(n)||(n=formatValue(e,n,t)),n}var i=formatPrimitive(e,r);if(i)return i;var o=Object.keys(r),s=arrayToHash(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(r)),isError(r)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return formatError(r);if(0===o.length){if(isFunction(r)){var u=r.name?": "+r.name:"";return e.stylize("[Function"+u+"]","special")}if(isRegExp(r))return e.stylize(RegExp.prototype.toString.call(r),"regexp");if(isDate(r))return e.stylize(Date.prototype.toString.call(r),"date");if(isError(r))return formatError(r)}var c="",a=!1,l=["{","}"];if(isArray(r)&&(a=!0,l=["[","]"]),isFunction(r)){c=" [Function"+(r.name?": "+r.name:"")+"]"}if(isRegExp(r)&&(c=" "+RegExp.prototype.toString.call(r)),isDate(r)&&(c=" "+Date.prototype.toUTCString.call(r)),isError(r)&&(c=" "+formatError(r)),0===o.length&&(!a||0==r.length))return l[0]+c+l[1];if(t<0)return isRegExp(r)?e.stylize(RegExp.prototype.toString.call(r),"regexp"):e.stylize("[Object]","special");e.seen.push(r);var p;return p=a?formatArray(e,r,t,s,o):o.map(function(n){return formatProperty(e,r,t,s,n,a)}),e.seen.pop(),reduceToSingleString(p,c,l)}function formatPrimitive(e,r){if(isUndefined(r))return e.stylize("undefined","undefined");if(isString(r)){var t="'"+JSON.stringify(r).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(t,"string")}return isNumber(r)?e.stylize(""+r,"number"):isBoolean(r)?e.stylize(""+r,"boolean"):isNull(r)?e.stylize("null","null"):void 0}function formatError(e){return"["+Error.prototype.toString.call(e)+"]"}function formatArray(e,r,t,n,i){for(var o=[],s=0,u=r.length;s<u;++s)hasOwnProperty(r,String(s))?o.push(formatProperty(e,r,t,n,String(s),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(formatProperty(e,r,t,n,i,!0))}),o}function formatProperty(e,r,t,n,i,o){var s,u,c;if(c=Object.getOwnPropertyDescriptor(r,i)||{value:r[i]},c.get?u=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(u=e.stylize("[Setter]","special")),hasOwnProperty(n,i)||(s="["+i+"]"),u||(e.seen.indexOf(c.value)<0?(u=isNull(t)?formatValue(e,c.value,null):formatValue(e,c.value,t-1),u.indexOf("\n")>-1&&(u=o?u.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+u.split("\n").map(function(e){return"   "+e}).join("\n"))):u=e.stylize("[Circular]","special")),isUndefined(s)){if(o&&i.match(/^\d+$/))return u;s=JSON.stringify(""+i),s.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+u}function reduceToSingleString(e,r,t){var n=0;return e.reduce(function(e,r){return n++,r.indexOf("\n")>=0&&n++,e+r.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?t[0]+(""===r?"":r+"\n ")+" "+e.join(",\n  ")+" "+t[1]:t[0]+r+" "+e.join(", ")+" "+t[1]}function isArray(e){return Array.isArray(e)}function isBoolean(e){return"boolean"==typeof e}function isNull(e){return null===e}function isNullOrUndefined(e){return null==e}function isNumber(e){return"number"==typeof e}function isString(e){return"string"==typeof e}function isSymbol(e){return"symbol"==typeof e}function isUndefined(e){return void 0===e}function isRegExp(e){return isObject(e)&&"[object RegExp]"===objectToString(e)}function isObject(e){return"object"==typeof e&&null!==e}function isDate(e){return isObject(e)&&"[object Date]"===objectToString(e)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(e){return"function"==typeof e}function isPrimitive(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function objectToString(e){return Object.prototype.toString.call(e)}function pad(e){return e<10?"0"+e.toString(10):e.toString(10)}function timestamp(){var e=new Date,r=[pad(e.getHours()),pad(e.getMinutes()),pad(e.getSeconds())].join(":");return[e.getDate(),months[e.getMonth()],r].join(" ")}function hasOwnProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)}var formatRegExp=/%[sdj%]/g;exports.format=function(e){if(!isString(e)){for(var r=[],t=0;t<arguments.length;t++)r.push(inspect(arguments[t]));return r.join(" ")}for(var t=1,n=arguments,i=n.length,o=String(e).replace(formatRegExp,function(e){if("%%"===e)return"%";if(t>=i)return e;switch(e){case"%s":return String(n[t++]);case"%d":return Number(n[t++]);case"%j":try{return JSON.stringify(n[t++])}catch(e){return"[Circular]"}default:return e}}),s=n[t];t<i;s=n[++t])isNull(s)||!isObject(s)?o+=" "+s:o+=" "+inspect(s);return o},exports.deprecate=function(e,r){function t(){if(!n){if(process.throwDeprecation)throw new Error(r);process.traceDeprecation?console.trace(r):console.error(r),n=!0}return e.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(e,r).apply(this,arguments)};if(!0===process.noDeprecation)return e;var n=!1;return t};var debugs={},debugEnviron;exports.debuglog=function(e){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),e=e.toUpperCase(),!debugs[e])if(new RegExp("\\b"+e+"\\b","i").test(debugEnviron)){var r=process.pid;debugs[e]=function(){var t=exports.format.apply(exports,arguments);console.error("%s %d: %s",e,r,t)}}else debugs[e]=function(){};return debugs[e]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(e,r){if(!r||!isObject(r))return e;for(var t=Object.keys(r),n=t.length;n--;)e[t[n]]=r[t[n]];return e};
}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})

},{"./support/isBuffer":56,"_process":52,"inherits":55}],58:[function(require,module,exports){
!function(e){"use strict";function t(){}function n(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function r(e){return function(){return this[e].apply(this,arguments)}}function i(e){return"function"==typeof e||e instanceof RegExp||!(!e||"object"!=typeof e)&&i(e.listener)}var s=t.prototype,o=e.EventEmitter;s.getListeners=function(e){var t,n,r=this._getEvents();if(e instanceof RegExp){t={};for(n in r)r.hasOwnProperty(n)&&e.test(n)&&(t[n]=r[n])}else t=r[e]||(r[e]=[]);return t},s.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},s.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&(t={},t[e]=n),t||n},s.addListener=function(e,t){if(!i(t))throw new TypeError("listener must be a function");var r,s=this.getListenersAsObject(e),o="object"==typeof t;for(r in s)s.hasOwnProperty(r)&&-1===n(s[r],t)&&s[r].push(o?t:{listener:t,once:!1});return this},s.on=r("addListener"),s.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},s.once=r("addOnceListener"),s.defineEvent=function(e){return this.getListeners(e),this},s.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},s.removeListener=function(e,t){var r,i,s=this.getListenersAsObject(e);for(i in s)s.hasOwnProperty(i)&&-1!==(r=n(s[i],t))&&s[i].splice(r,1);return this},s.off=r("removeListener"),s.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},s.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},s.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(r=n.length;r--;)s.call(this,t,n[r]);else for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&("function"==typeof i?s.call(this,r,i):o.call(this,r,i));return this},s.removeEvent=function(e){var t,n=typeof e,r=this._getEvents();if("string"===n)delete r[e];else if(e instanceof RegExp)for(t in r)r.hasOwnProperty(t)&&e.test(t)&&delete r[t];else delete this._events;return this},s.removeAllListeners=r("removeEvent"),s.emitEvent=function(e,t){var n,r,i,s,o=this.getListenersAsObject(e);for(s in o)if(o.hasOwnProperty(s))for(n=o[s].slice(0),i=0;i<n.length;i++)r=n[i],!0===r.once&&this.removeListener(e,r.listener),r.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,r.listener);return this},s.trigger=r("emitEvent"),s.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},s.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},s._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},s._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return e.EventEmitter=o,t},"function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:e.EventEmitter=t}(this||{});
},{}],59:[function(require,module,exports){
function DnsClient(e,r,o){var t=this;t._dnsDb=e,t._rpc=r,t._dnsServerAddress=o.dnsServer,t._apiBasePath=o.apiPath,t._remoteApiObject=ApiBuilder.toObject(apiConfig,function(e,r,o,p){t._rpc.request(t._dnsServerAddress,t._apiBasePath+r,o.query,"object"==typeof apiConfig[e].requestOptions?apiConfig[e].requestOptions:{},p)}),Utils.objectForEach(t._remoteApiObject,function(e,r){"function"!=typeof t[r]&&(t[r]=function(){"string"==typeof t._dnsServerAddress?t._remoteApiObject[r].apply(t._remoteApiObject,Array.prototype.slice.call(arguments)):t._dnsDb[r].apply(t._dnsDb,Array.prototype.slice.call(arguments))})})}var Utils=require("./Utils"),ApiBuilder=require("agnostic-router-api-builder"),apiConfig=require("./apiConfig");DnsClient.prototype.subscribeToGroup=function(){var e=this;if("string"==typeof e._dnsServerAddress){var r=Array.prototype.slice.call(arguments),o=r.pop(),t=function(r,t){null==r&&e._dnsDb.groupsOplog.applyOp(t),o(r,t)};e._remoteApiObject.subscribeToGroup.apply(e._remoteApiObject,r.concat([t]))}else e._dnsDb.subscribeToGroup.apply(e._dnsDb,Array.prototype.slice.call(arguments))},DnsClient.prototype.groupAddresses=function(){var e=this,r=Utils.parseArgs(arguments,[{name:"groupName",required:!0,level:0,type:"string"},{name:"options",level:1,type:"object",default:{}},{name:"callback",required:!0,level:0,type:"function"}]),o={groupLookup:!0,groupSubscribe:!1};r.options=Utils.objectMerge(o,r.options),e._dnsDb.groupAddresses(r.groupName,function(o,t){o&&r.options.groupLookup&&"string"==typeof e._dnsServerAddress?r.options.groupSubscribe?e.subscribeToGroup(r.groupName,function(o,t){o?r.callback(o,null):"subscribe"==Utils.objectGet(t,["operation","operation"])&&"find-complete"==Utils.objectGet(t,["operation","status"])&&e.groupAddresses(r.groupName,{groupLookup:!1,groupSubscribe:!1},r.callback)}):e._remoteApiObject.groupAddresses(r.groupName,r.callback):r.callback(o,t)})},module.exports=function(e,r,o){return new DnsClient(e,r,o)};
},{"./Utils":63,"./apiConfig":64,"agnostic-router-api-builder":1}],60:[function(require,module,exports){
function DnsDb(o){var s={removeEmptyGroups:!0,removeEmptyAddresses:!0,groupsOplogMax:1e3,addressesOplogMax:1e3};this._options=Utils.objectMerge(s,o),this.groups=Mongolocal({}),this.groupsOplog=Oms.OmsOplog(this.groups,{max:this._options.groupsOplogMax},{}),this.groupsOplogSubscriptions=Oms.OmsOplogSubscriptions(this.groupsOplog),this.addresses=Mongolocal({}),this.addressesOplog=Oms.OmsOplog(this.addresses,{max:this._options.addressesOplogMax},{}),this.addressesOplogSubscriptions=Oms.OmsOplogSubscriptions(this.addressesOplog)}var Mongolocal=require("mongolocal"),Oms=require("oms"),Utils=require("./Utils");DnsDb.prototype.addToGroup=function(o,s,e){function r(e){var r={_id:o},t=Utils.objectMerge(r,{$addToSet:{groups:s}});n.addresses.update(r,t,{upsert:!0},e)}function t(o,s){"function"==typeof e&&e(o,s)}var n=this;"string"!=typeof o?t("address_format_incorrect"):"string"!=typeof s?t("group_format_incorrect"):function(e){var r={_id:s},t=Utils.objectMerge(r,{$addToSet:{addresses:o}});n.groups.update(r,t,{upsert:!0},e)}(function(o){o?t(o,null):r(function(o){o?t(o,null):t(null,!0)})})},DnsDb.prototype.removeFromGroup=function(o,s,e){function r(e){var r={_id:o},t=Utils.objectMerge(r,{$pull:{groups:s}});n.addresses.update(r,t,function(o,s){if(o)e(o);else{if(n._options.removeEmptyAddresses){var t=Utils.objectMerge(r,{groups:{$size:0}});n.addresses.remove(t)}e(null)}})}function t(o,s){"function"==typeof e&&e(o,s)}var n=this;"string"!=typeof o?t("address_format_incorrect"):"string"!=typeof s?t("group_format_incorrect"):function(e){var r={_id:s},t=Utils.objectMerge(r,{$pull:{addresses:o}});n.groups.update(r,t,function(o,s){if(o)e(o);else{if(n._options.removeEmptyGroups){var t=Utils.objectMerge(r,{addresses:{$size:0}});n.groups.remove(t)}e(null)}})}(function(o){o?t(o,null):r(function(o){o?t(o,null):t(null,!0)})})},DnsDb.prototype.removeFromAllGroups=function(o,s){function e(o,e){"function"==typeof s&&s(o,e)}var r=this;"string"!=typeof o?e("address_format_incorrect"):r.addresses.findOne({_id:o},function(s,t){s?e(s,null):null==t?e(null,!0):(Array.isArray(t.groups)&&t.groups.forEach(function(s){r.removeFromGroup(o,s)}),e(null,!0))})},DnsDb.prototype.groupAddresses=function(o,s){this.groups.findOne({_id:o},function(o,e){o?s(o,null):null==e?s("group_undefined",null):s(null,e.addresses)})},DnsDb.prototype.subscribeToGroup=function(){var o=Utils.parseArgs(arguments,[{name:"groupQuery",level:1,types:["object","string"],default:{}},{name:"oplogQuery",level:1,type:"object",default:{}},{name:"callback",level:0,type:"function"}]);"string"==typeof o.groupQuery&&(o.groupQuery={_id:o.groupQuery}),this.groupsOplogSubscriptions.findSubscribe(o.groupQuery,o.oplogQuery,function(s,e){s?o.callback(s,null):o.callback(null,e)})},DnsDb.prototype.unsubscribe=function(o,s){"string"!=typeof o?s("subscription_undefined",null):this.groupsOplogSubscriptions.unsubscribe(o,s)},module.exports=function(o){return new DnsDb(o)};
},{"./Utils":63,"mongolocal":29,"oms":43}],61:[function(require,module,exports){
module.exports=function(r){var u=require("./apiConfig"),e=require("agnostic-router-api-builder"),o=require("oms"),i=o.OmsUtils,n=require("agnostic-router")();return n.use("/group/subscribe",function(u,e,o){r.subscribeToGroup("string"==typeof u.query.group?u.query.group:u.query.groupQuery,u.query.oplogQuery,function(r,u){r?e(r,null):e(null,i.operationDocMin(u))})}),e.toRouter(u,r,n),n};
},{"./apiConfig":64,"agnostic-router":3,"agnostic-router-api-builder":1,"oms":43}],62:[function(require,module,exports){
function DnsRpc(e){var n=this,t={dnsDb:{apiPath:"/api/dns",public:!1},dnsClient:{apiPath:"/api/dns"},network:{}};n._config=Utils.objectMerge(t,e),n._config.dnsDb=Utils.objectMerge(t.dnsDb,n._config.dnsDb),n._config.dnsClient=Utils.objectMerge(t.dnsClient,n._config.dnsClient),n.connected=!1,n.rpc=NodeNetworkRpc(n._config.network),n.network=n.rpc.network,n.router=n.rpc.router,n.network.on("address",function(e){n.address=e,n.emit("address",e),void 0===e?(n.connected=!1,void 0!==n._prevAddress&&n.connected&&n.dnsClient.removeFromAllGroups(n._prevAddress),n.emit("disconnect")):(n.connected=!0,Array.isArray(n._config.groups)&&n._config.groups.forEach(function(t){n.dnsClient.addToGroup(e,t)}),n.emit("connect")),n._prevAddress=e}),n.dnsDb=DnsDb(n._config.dnsDb),n.dnsClient=DnsClient(n.dnsDb,n.rpc,n._config.dnsClient),"boolean"==typeof n._config.dnsDb.public&&n._config.dnsDb.public&&n.router.use(n._config.dnsDb.apiPath,DnsDbRouter(n.dnsDb))}var EventEmitter=require("wolfy87-eventemitter"),NodeNetworkRpc=require("node-network-rpc"),DnsClient=require("./DnsClient"),DnsDb=require("./DnsDb"),DnsDbRouter=require("./DnsDbRouter"),Utils=require("./Utils");DnsRpc.prototype.__proto__=EventEmitter.prototype,DnsRpc.prototype.request=function(){function e(e,n){"function"==typeof t.callback&&t.callback(e,n)}var n=this,t=Utils.parseArgs(arguments,[{name:"destGroup",level:1,type:"string",default:n._config.defaultGroup},{name:"path",level:0,validate:function(e,n){return"string"==typeof e&&"/"==e[0]}},{name:"query",level:1,type:"object",default:{}},{name:"options",level:2,type:"object",default:{}},{name:"callback",level:1,type:"function"}]);"string"!=typeof t.destGroup?e("destGroup_undefined",null):n.dnsClient.groupAddresses(t.destGroup,t.options,function(o,r){o?"group_undefined"==o||e(o,null):n.rpc.request(r,t.path,t.query,t.options,e)})},DnsRpc.prototype.addConnection=function(){this.rpc.addConnection.apply(this.rpc,Array.prototype.slice.call(arguments))},module.exports=function(e){return new DnsRpc(e)};
},{"./DnsClient":59,"./DnsDb":60,"./DnsDbRouter":61,"./Utils":63,"node-network-rpc":34,"wolfy87-eventemitter":58}],63:[function(require,module,exports){
var Utils={};Utils.arrayToObject=function(e,t,n){var r={};return"function"==typeof e.forEach&&e.forEach(function(e,o){void 0!==e[t]&&(r[e[t]]=e),void 0!==n&&(r[e[t]][n]=o)}),r},Utils.objectFilterProperties=function(e,t){var n={};return t.forEach(function(t){n[t]=e[t]}),n},Utils.objectDeepEqual=function(e,t){if("object"==typeof e&&null!=e&&"object"==typeof t&&null!=t){if(Object.keys(e).length!=Object.keys(t).length)return!1;for(var n in e){if(!t.hasOwnProperty(n))return!1;if(!Utils.objectDeepEqual(e[n],t[n]))return!1}return!0}return e===t},Utils.objectContainsObject=function(e,t,n){"boolean"!=typeof n&&(n=!1),null===e&&(e={}),null===t&&(t={});for(var r in t)if(t.hasOwnProperty(r)){if(!e.hasOwnProperty(r))return!1;if(typeof e[r]!=typeof t[r])return!1;if("object"==typeof e[r]&&n&&!Utils.objectContainsObject(e[r],t[r],n))return!1;if("object"==typeof e[r]&&!n&&e[r]!==t[r])return!1;if("object"!=typeof e[r]&&e[r]!==t[r])return!1}return!0},Utils.objectFilter=function(e,t){var n={};return this.objectForEach(e,function(e,r,o){t(e,r,o)&&(n[r]=e)}),n},Utils.objectForEach=function(e,t){var n;for(n in e)e.hasOwnProperty(n)&&t(e[n],n,e)},Utils.objectGet=function(e,t){var n=this;if(0==t.length)return e;if("object"==typeof e){if(("string"==typeof t[0]||"number"==typeof t[0])&&null!==e&&e.hasOwnProperty(t[0]))return this.objectGet(e[t[0]],t.slice(1));if(null===t[0]){if(Array.isArray(e)){var r=[];e.forEach(function(e,o){r[o]=n.objectGet(e,t.slice(1))})}else{var r={};this.objectForEach(e,function(e,o){r[o]=n.objectGet(e,t.slice(1))})}return r}if(t[0]instanceof RegExp){var r={};return this.objectForEach(e,function(e,o){o.match(t[0])&&(r[o]=n.objectGet(e,t.slice(1)))}),r}if("function"==typeof t[0]){if(e instanceof Array){var r=[];e.forEach(function(e,o,i){t[0](e,o,i)&&(r[o]=n.objectGet(e,t.slice(1)))})}else{var r={};this.objectForEach(n.objectFilter(e,t[0]),function(e,o){r[o]=n.objectGet(e,t.slice(1))})}return r}if(t[0]instanceof Array){if(e instanceof Array){var r=[];t[0].forEach(function(t,n){r[n]=e[n]})}else{var r={};this.objectForEach(n.objectFilterProperties(e,t[0]),function(e,o){r[o]=n.objectGet(e,t.slice(1))})}return r}}},Utils.objectSet=function(e,t,n){return 1==t.length?(e[t[0]]=n,!0):(void 0===e[t[0]]&&(e[t[0]]={}),this.objectSet(e[t[0]],t.slice(1),n))},Utils.objectIsset=function(e,t){return 1==t.length?void 0!==e[t[0]]:void 0!==e[t[0]]&&this.objectIsset(e[t[0]],t.slice(1))},Utils.objectMerge=function(){var e={};return this.objectForEach(arguments,function(t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}),e},Utils.uniqueId=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},Utils.parseArgs=function(e,t){function n(e,t){return"function"==typeof e.validate?e.validate(t):"string"==typeof e.type?typeof t==e.type:!Array.isArray(e.types)||e.types.indexOf(typeof t)>=0}function r(e,t){for(var n=t;n<e.length;n++)if(void 0===e[n]||!e[n].required)return!0;return!1}var o={},i=0;return Array.isArray(e)||(e=Array.prototype.slice.call(e)),e.forEach(function(e,c){for(var u=i;u<t.length;u++){if(t[u].required){if(n(t[u],e)){t[u].matched=!0,o[t[u].name]=e,i++;break}throw"missing_required"}if(!t[u].required&&(r(t,u)||t[u].level>t[u-1].level&&t[u-1].matched)&&n(t[u],e)){t[u].matched=!0,o[t[u].name]=e,i++;break}t[u].matched=!1,i++}}),t.forEach(function(e){void 0===o[e.name]&&void 0!==e.default&&(o[e.name]=e.default)}),o},Utils.callbackQueue=function(){function e(){r||(r=!0,n.queueCompleteCallback.apply(this,Array.prototype.slice.call(arguments)))}function t(){o++,"function"==typeof n.queueFunctions[o]?Array.isArray(n.queueFunctionArgs)&&!n.options.expand?n.queueFunctions[o](n.queueFunctionArgs,t,e):Array.isArray(n.queueFunctionArgs)&&n.options.expand?n.queueFunctions[o].apply(this,n.queueFunctionArgs.concat([t,e])):n.queueFunctions[o](t,e):"function"!=typeof n.queueNoMatchCallback||r||n.queueNoMatchCallback()}var n=Utils.parseArgs(arguments,[{name:"queueFunctions",level:0,validate:function(e,t){return Array.isArray(e)}},{name:"queueFunctionArgs",level:1,validate:function(e,t){return Array.isArray(e)}},{name:"queueCompleteCallback",level:0,validate:function(e,t){return"function"==typeof e}},{name:"queueNoMatchCallback",level:1,validate:function(e,t){return"function"==typeof e}},{name:"options",level:1,validate:function(e,t){return"object"==typeof e},default:{}}]);n.options=Utils.objectMerge({expand:!1},n.options);var r=!1,o=-1;t()},module.exports=Utils;
},{}],64:[function(require,module,exports){
module.exports={"addToGroup":{"pattern":"/join","arguments":[{"name":"address","source":"query"},{"name":"group","source":"query"}],"requestOptions":{"multipleResponses":false}},"removeFromGroup":{"pattern":"/leave","arguments":[{"name":"address","source":"query"},{"name":"group","source":"query"}],"requestOptions":{"multipleResponses":false}},"removeFromAllGroups":{"pattern":"/leaveall","arguments":[{"name":"address","source":"query"}],"requestOptions":{"multipleResponses":false}},"groupAddresses":{"pattern":"/group/find","arguments":[{"name":"group","source":"query"}],"requestOptions":{"multipleResponses":false}},"subscribeToGroup":{"pattern":"/group/subscribe","arguments":[{"name":"groupQuery","source":"query","level":1,"types":["object","string"],"default":{}},{"name":"oplogQuery","source":"query","level":1,"type":"object","default":{}}],"requestOptions":{"multipleResponses":true}},"unsubscribe":{"pattern":"/group/unsubscribe","arguments":[{"name":"subscriptionId","source":"query"}],"requestOptions":{"multipleResponses":false}}}
},{}]},{},[62])(62)
});


//# sourceMappingURL=nodenetworknsrpc.js.map